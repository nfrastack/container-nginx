# SPDX-FileCopyrightText: © 2026 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

is_null() {
    case "${1,,}" in
        null|none|unset) return 0 ;;
        *) return 1 ;;
    esac
}

resolve_site_var() {
    local varname="$1"
    local default_val="$2"
    local allow_defaults="$3"
    local val="${!varname}"

    if [ -n "${val}" ] && is_null "${val}" ; then
        echo ""
        return
    fi

    if [ -z "${val}" ] && var_true "${allow_defaults}" ; then
        echo "${default_val}"
        return
    fi

    echo "${val}"
}


nginx_authentication_configure_basic() {
    local _sitename="${1}"
    local allow_defaults="${2:-true}"
    local _auth_dir="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication"
    local _auth_file="${_auth_dir}/basic-authorized_users"
    create_folder "${_auth_dir}" root:www-data 755
    touch "${_auth_file}"
    local prefix="NGINX_SITE_${_sitename^^}_AUTHENTICATION_BASIC_"
    local has_numbered
    if ! printenv | grep -q "^${prefix}USER[0-9]\+="; then
        local user_var="${prefix}USER"
        local user1_var="${prefix}USER1"
        local pass_var="${prefix}PASS"
        local pass1_var="${prefix}PASS1"
        if [ -n "${!user_var}" ] && [ -z "${!user1_var}" ]; then
            eval "export ${user1_var}='${!user_var}'"
            unset "${user_var}"
        fi
        if [ -n "${!pass_var}" ] && [ -z "${!pass1_var}" ]; then
            eval "export ${pass1_var}='${!pass_var}'"
            unset "${pass_var}"
        fi
    fi
    local user_num=0
    user_num=$(printenv | grep -c "^${prefix}USER[0-9]*=")
    if [ "${user_num}" -eq 0 ] && var_true "${allow_defaults}"; then
        prefix="NGINX_AUTHENTICATION_BASIC_"
        if printenv | grep -q "^${prefix}USER[0-9]\+="; then
            has_numbered=true
        else
            has_numbered=false
        fi
        if [ "${has_numbered}" = false ]; then
            user_var="${prefix}USER"
            user1_var="${prefix}USER1"
            pass_var="${prefix}PASS"
            pass1_var="${prefix}PASS1"
            if [ -n "${!user_var}" ] && [ -z "${!user1_var}" ]; then
                eval "export ${user1_var}='${!user_var}'"
                unset "${user_var}"
            fi
            if [ -n "${!pass_var}" ] && [ -z "${!pass1_var}" ]; then
                eval "export ${pass1_var}='${!pass_var}'"
                unset "${pass_var}"
            fi
        fi
        user_num=$(printenv | grep -c "^${prefix}USER[0-9]*=")
    fi
    if [ "${user_num}" -eq 0 ]; then
        print_warn "[configure_site/${_sitename}] [authentication/basic] No basic auth users found. Skipping user creation."
        return
    fi

    for ((num = 1; num <= user_num; num++)); do
        local buser_var="${prefix}USER${num}"
        local bpass_var="${prefix}PASS${num}"
        local buser="${!buser_var}"
        local bpass="${!bpass_var}"
        if [ -z "${buser}" ] || [ -z "${bpass}" ]; then
            print_warn "[configure_site/${_sitename}] [authentication/basic] Skipping empty user/pass for entry $num"
            continue
        fi
        print_warn "[configure_site/${_sitename}] [authentication/basic] Created user: ${buser}"
        htpasswd -b -n "${buser}" "${bpass}" | silent tee -a "${_auth_file}"
    done

    print_notice "[configure_site/${_sitename}] [authentication/basic] Enabled Authentication"
            render_template \
                    /container/data/nginx/templates/site/server-authentication_basic.template \
                    "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/30-auth_basic.conf \
                        _auth_title \
                        _auth_file
}

nginx_authentication_configure_ldap() {
    local _sitename="${1}"
    local allow_defaults="${2:-true}"
    local ldap_server_name="${_sitename}_ldap_server"
    transform_var file \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_HOST \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_PORT \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_BASE_DN \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_BIND_DN \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_BIND_PW \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_ATTRIBUTE \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_SCOPE \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_FILTER \
                    NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_GROUP_ATTRIBUTE \
                    NGINX_AUTHENTICATION_LDAP_HOST \
                    NGINX_AUTHENTICATION_LDAP_PORT \
                    NGINX_AUTHENTICATION_LDAP_BASE_DN \
                    NGINX_AUTHENTICATION_LDAP_BIND_DN \
                    NGINX_AUTHENTICATION_LDAP_BIND_PW \
                    NGINX_AUTHENTICATION_LDAP_ATTRIBUTE \
                    NGINX_AUTHENTICATION_LDAP_SCOPE \
                    NGINX_AUTHENTICATION_LDAP_FILTER \
                    NGINX_AUTHENTICATION_LDAP_GROUP_ATTRIBUTE
        local host_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_HOST"
        local port_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_PORT"
        local base_dn_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_BASE_DN"
        local bind_dn_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_BIND_DN"
        local bind_pw_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_BIND_PW"
        local attr_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_ATTRIBUTE"
        local scope_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_SCOPE"
        local filter_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_FILTER"
        local group_attr_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LDAP_GROUP_ATTRIBUTE"
        local host="$(resolve_site_var "${host_var}" "${NGINX_AUTHENTICATION_LDAP_HOST}" "${allow_defaults}")"
        local port="$(resolve_site_var "${port_var}" "${NGINX_AUTHENTICATION_LDAP_PORT}" "${allow_defaults}")"
        local base_dn="$(resolve_site_var "${base_dn_var}" "${NGINX_AUTHENTICATION_LDAP_BASE_DN}" "${allow_defaults}")"
        local bind_dn="$(resolve_site_var "${bind_dn_var}" "${NGINX_AUTHENTICATION_LDAP_BIND_DN}" "${allow_defaults}")"
        local bind_pw="$(resolve_site_var "${bind_pw_var}" "${NGINX_AUTHENTICATION_LDAP_BIND_PW}" "${allow_defaults}")"
        local attr="$(resolve_site_var "${attr_var}" "${NGINX_AUTHENTICATION_LDAP_ATTRIBUTE}" "${allow_defaults}")"
        local scope="$(resolve_site_var "${scope_var}" "${NGINX_AUTHENTICATION_LDAP_SCOPE}" "${allow_defaults}")"
        local filter="$(resolve_site_var "${filter_var}" "${NGINX_AUTHENTICATION_LDAP_FILTER}" "${allow_defaults}")"
        local group_attr="$(resolve_site_var "${group_attr_var}" "${NGINX_AUTHENTICATION_LDAP_GROUP_ATTRIBUTE}" "${allow_defaults}")"
    export ldap_server_name host port base_dn bind_dn bind_pw attr scope filter group_attr

    render_template \
                    /container/data/nginx/templates/site/server-pre-authentication_ldap.template \
                    "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-pre/20-auth_ldap_server.conf \
                        ldap_server_name \
                        host \
                        port \
                        base_dn \
                        bind_dn \
                        bind_pw \
                        attr \
                        scope \
                        filter \
                        group_attr

    render_template \
                    /container/data/nginx/templates/site/server-authentication_ldap.template \
                    "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/30-auth_ldap.conf \
                        ldap_server_name \
                        _auth_title
    print_info "[configure_site/${_sitename}] [authentication/ldap] Enabled Authentication"
}

nginx_authentication_configure_llng() {
    local _sitename="${1:-}"
    local allow_defaults="${2:-true}"
    print_notice "[configure_site/${_sitename}] [authentication/llng] Enabling Authentication"
    create_folder "${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication" root:www-data 750
    params_path="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication/llng-params"
    auth_request_path="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication/llng-auth_request"

    site_prefix="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LLNG_"
    handler_host_var="${site_prefix}HANDLER_HOST"
    handler_port_var="${site_prefix}HANDLER_PORT"
    buffer_size_var="${site_prefix}FASTCGI_BUFFER_SIZE"
    buffers_var="${site_prefix}FASTCGI_BUFFERS"
    upstream_opts_var="${site_prefix}UPSTREAM_OPTIONS"

    handler_host_val="$(resolve_site_var "${handler_host_var}" "${NGINX_AUTHENTICATION_LLNG_HANDLER_HOST}" "${allow_defaults}")"
    handler_port_val="$(resolve_site_var "${handler_port_var}" "${NGINX_AUTHENTICATION_LLNG_HANDLER_PORT}" "${allow_defaults}")"
    buffer_size_val="$(resolve_site_var "${buffer_size_var}" "${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE}" "${allow_defaults}")"
    buffers_val="$(resolve_site_var "${buffers_var}" "${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS}" "${allow_defaults}")"
    upstream_opts_val="$(resolve_site_var "${upstream_opts_var}" "${NGINX_AUTHENTICATION_LLNG_UPSTREAM_OPTIONS}" "${allow_defaults}")"

    buffer_size_val="${buffer_size_val#\"}"; buffer_size_val="${buffer_size_val%\"}"
    buffer_size_val="${buffer_size_val#\'}"; buffer_size_val="${buffer_size_val%\'}"
    buffers_val="${buffers_val#\"}"; buffers_val="${buffers_val%\"}"
    buffers_val="${buffers_val#\'}"; buffers_val="${buffers_val%\'}"
    upstream_opts_val="${upstream_opts_val#\"}"; upstream_opts_val="${upstream_opts_val%\"}"
    upstream_opts_val="${upstream_opts_val#\'}"; upstream_opts_val="${upstream_opts_val%\'}"

    export _auth_handler_port="${handler_port_val}"
    export _auth_fastcgi_buffer_size="${buffer_size_val}"
    export _auth_fastcgi_buffers="${buffers_val}"
    export _auth_upstream_options="${upstream_opts_val}"

    create_folder "${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/upstream" root:www-data 750

    # Determine upstream keepalive per-site (falls back to global when allowed)
    local upstream_keepalive_enable_var="NGINX_SITE_${_sitename^^}_ENABLE_UPSTREAM_KEEPALIVE"
    local upstream_keepalive_enable_val
    upstream_keepalive_enable_val="$(resolve_site_var "${upstream_keepalive_enable_var}" "${NGINX_ENABLE_UPSTREAM_KEEPALIVE}" "${allow_defaults}")"
    local upstream_keepalive_count_var="NGINX_SITE_${_sitename^^}_UPSTREAM_KEEPALIVE"
    local upstream_keepalive_count_val
    upstream_keepalive_count_val="$(resolve_site_var "${upstream_keepalive_count_var}" "${NGINX_UPSTREAM_KEEPALIVE}" "${allow_defaults}")"
    if var_true "${upstream_keepalive_enable_val}" ; then
        upstream_keepalive="    keepalive ${upstream_keepalive_count_val};"
    else
        upstream_keepalive=""
    fi
    export upstream_keepalive

    if [ -n "${_sitename}" ]; then
        suffix="-${_sitename}"
    else
        suffix=""
    fi
    upstream_name="llng-upstream-pool${suffix}"
    upstream_file="${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/upstream/llng-upstream${suffix}.conf"
    llng_upstream_hosts=$(echo "${handler_host_val}" | tr "," "\n")
    effective_handler_port="${handler_port_val}"

    export _auth_upstream_name="${upstream_name}"
    export upstream_name
    servers=""
    if [ -n "${llng_upstream_hosts}" ]; then
        for host in ${llng_upstream_hosts}; do
            if [[ ${host} != *":"* ]]; then
                llng_handler_listen_port=":${effective_handler_port}"
            else
                llng_handler_listen_port=""
            fi
            opts="${upstream_opts_val}"
            opts="${opts#\"}"; opts="${opts%\"}"
            opts="${opts#\'}"; opts="${opts%\'}"
            servers="${servers}    server ${host}${llng_handler_listen_port} ${opts};"$'\n'
        done
    fi

    export _auth_upstream_servers="${servers}"

    render_template \
                    /container/data/nginx/templates/server/authentication-upstream-llng.template \
                    "${upstream_file}" \
                        upstream_keepalive \
                        upstream_name \
                        _auth_upstream_servers

    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE#\"}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE%\"}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE#\'}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE%\'}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS#\"}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS%\"}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS#\'}"
    NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS="${NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS%\'}"

    render_template \
                    /container/data/nginx/templates/site/authentication-llng-params.template \
                    "${params_path}"
    render_template \
                    /container/data/nginx/templates/site/location-authentication-llng-auth_request.template \
                    "${auth_request_path}"

    _() {
        local varname="$1"
        local raw="${!varname}"
        [ -z "${raw}" ] && return
        IFS=',' read -r -a array <<<"${raw}"
        for i in 0 1 2; do
            array[$i]="${array[$i]#\"}"
            array[$i]="${array[$i]%\"}"
            array[$i]="${array[$i]#\'}"
            array[$i]="${array[$i]%\'}"
        done
        print_notice "[configure_site/${_sitename}] [authentication/llng] Allowing LLNG Attribute: '${array[0]}' ${_sitename:+for site ${_sitename}}"
        echo "fastcgi_param ${array[0]} \$${array[1]};" | silent tee -a "${params_path}"
        echo "auth_request_set \$${array[1]} \$${array[2]};" | silent tee -a "${auth_request_path}"
    }

    __() {
        local in="$1"
        local idx
        if [[ "${in}" =~ ^[0-9]+$ ]]; then
            idx=$((10#${in}))
        else
            idx="${in}"
        fi
        local vn_padded="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LLNG_ATTRIBUTE$(printf '%02d' "${idx}")"
        local vn_unpadded="NGINX_SITE_${_sitename^^}_AUTHENTICATION_LLNG_ATTRIBUTE${idx}"
        _ "${vn_padded}"
        _ "${vn_unpadded}"
    }

    ___() {
        local in="$1"
        local idx
        if [[ "${in}" =~ ^[0-9]+$ ]]; then
            idx=$((10#${in}))
        else
            idx="${in}"
        fi
        local vn_padded="NGINX_AUTHENTICATION_LLNG_ATTRIBUTE$(printf '%02d' "${idx}")"
        local vn_unpadded="NGINX_AUTHENTICATION_LLNG_ATTRIBUTE${idx}"
        _ "${vn_padded}"
        _ "${vn_unpadded}"
    }

    local sc=$(printenv | grep -cE "^NGINX_SITE_${_sitename^^}_AUTHENTICATION_LLNG_ATTRIBUTE[0-9]+=")
    if [ "${sc}" -gt 0 ]; then floop "${sc}" __ ETUBIRTTA_GNLL_NOITACITNEHTUA_EMANETIS_ETIS_XNIGN ; fi

    if var_true "${allow_defaults}" ; then
        gac=$(printenv | grep -cE '^NGINX_AUTHENTICATION_LLNG_ATTRIBUTE[0-9]+=')
        if [ "${gac}" -gt 0 ]; then floop "${gac}" ___ ETUBIRTTA_GNLL_NOITACITNEHTUA_XNIGN ; fi
    fi

    render_template \
                        /container/data/nginx/templates/site/location-authentication-llng_lmauth.template \
                        "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/00-authentication-llng_lmauth.conf \
                            _auth_upstream_name \
                            _auth_handler_port \
                            _auth_fastcgi_buffer_size \
                            _auth_fastcgi_buffers

    local auth_server_include="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/server-begin/zz-llng-auth_request.conf"
    write_file "${auth_server_include}":644 <<EOF
# LLNG auth_request include for site ${_sitename} - This should go inside of a location block if at all possible but _should_ work without it.
include ${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication/llng-auth_request;
include ${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication/llng-params;
EOF
}

nginx_config_reload_run() {
    while inotifywait -q -e create,delete,modify,attrib "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}" "${NGINX_CONFIG_PATH%/}"/sites.enabled "${NGINX_CONFIG_PATH%/}"/server.enabled "${NGINX_INCLUDE_CONFIGURATION}"; do
          print_info "[config_reload] Reloading Nginx configuration do to a detected change"
          nginx -s reload
          exit 0
    done
}

nginx_server_configure() {
    create_folder "${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d, \
                   ${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/http,
                   ${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/events" \
                   root:"${NGINX_GROUP}" 750

    render_template /container/data/nginx/templates/server/server.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}" \
                        NGINX_CONFIG_PATH \
                        NGINX_CONFIG_FILE \
                        NGINX_GROUP \
                        NGINX_USER \

    truefalse_onoff NGINX_ENABLE_MULTI_ACCEPT lowercase
    render_template /container/data/nginx/templates/server/events.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/events/events.conf \
                        NGINX_CONNECTION_PROCESSING_METHOD \
                        NGINX_ENABLE_MULTI_ACCEPT \
                        NGINX_WORKER_CONNECTIONS

    render_template /container/data/nginx/templates/server/http-mime_types.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/mime_types.conf \
                        NGINX_MIME_TYPE_DEFAULT \
                        NGINX_MIME_TYPES_PATH \
                        NGINX_MIME_TYPES_FILE

    render_template /container/data/nginx/templates/server/http-client.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/client.conf \
                        NGINX_CLIENT_BODY_BUFFER_SIZE \
                        NGINX_UPLOAD_MAX_SIZE

    render_template /container/data/nginx/templates/server/http-fastcgi_buffers.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/fastcgi_buffers.conf \
                        NGINX_FASTCGI_BUFFERS \
                        NGINX_FASTCGI_BUFFER_SIZE

    truefalse_onoff NGINX_ENABLE_SENDFILE lowercase
    render_template /container/data/nginx/templates/server/http-sendfile.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/sendfile.conf \
                        NGINX_ENABLE_SENDFILE

    render_template /container/data/nginx/templates/server/http-keepalive.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/keepalive.conf \
                        NGINX_KEEPALIVE_REQUESTS \
                        NGINX_KEEPALIVE_TIMEOUT

    render_template /container/data/nginx/templates/server/http-log_formats.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/log_formats.conf

    truefalse_onoff NGINX_ENABLE_PCRE_JIT lowercase
    render_template /container/data/nginx/templates/server/server-pcre_jit.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/pcre_jit.conf \
                        NGINX_ENABLE_PCRE_JIT

    truefalse_onoff NGINX_ENABLE_TCPNODELAY lowercase
    truefalse_onoff NGINX_ENABLE_TCPNOPUSH lowercase
    render_template /container/data/nginx/templates/server/http-tcp.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/tcp.conf \
                        NGINX_ENABLE_TCPNOPUSH \
                        NGINX_ENABLE_TCPNODELAY

    render_template /container/data/nginx/templates/server/http-hash-proxy_headers.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/hash-proxy_headers.conf \
                        NGINX_PROXY_HEADERS_HASH_MAX_SIZE \
                        NGINX_PROXY_HEADERS_HASH_BUCKET_SIZE

    render_template /container/data/nginx/templates/server/http-hash-server_names.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/hash-server_names.conf \
                        NGINX_SERVER_NAMES_HASH_BUCKET_SIZE

    truefalse_onoff NGINX_ENABLE_RESET_TIMEDOUT_CONNECTION lowercase
    render_template /container/data/nginx/templates/server/http-timeouts.template \
                    "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/timeouts.conf \
                        NGINX_CLIENT_BODY_TIMEOUT \
                        NGINX_ENABLE_RESET_TIMEDOUT_CONNECTION \
                        NGINX_SEND_TIMEOUT

    for server_config in \
                            acme \
                            blockbots \
                            cache_open_file \
                            compression_brotli \
                            compression_gzip \
                            ddos_protection \
                            metrics \
                            mimetypes \
                            proxy_buffering \
                            resolver \
                            reverse_proxy \
                            tls \
                            tokens \
                        ; do
          call nginx_server_configure_"${server_config}" "${_sitename}"
    done
}

nginx_server_configure_blockbots() {
    if var_true "${NGINX_ENABLE_BLOCK_BOTS}" ; then
        create_folder "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH}" root:"${NGINX_GROUP}" 750
        local gb_src="/container/data/nginx/blockbots/globalblacklist.conf"
        if [ -f "${gb_src}" ]; then
            ln -sf "${gb_src}" "${gb_dest_dir}/50-blockbots"
            print_info "[server_configure_blockbots] Enabled Bot Blocking"
        fi
        sed -i \
                -e "s|/etc/nginx/bots.d/|/container/data/nginx/blockbots/|g" \
                -e "s|/container/data/nginx/blockbots/bad-referrer-words.conf|"${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/bad-referrer-words.conf|g" \
                -e "s|/container/data/nginx/blockbots/blacklist-ips.conf|"${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/blacklist-ips.conf|g" \
                -e "s|/container/data/nginx/blockbots/blacklist-user-agents.conf|"${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/blacklist-user-agents.conf|g" \
                -e "s|/container/data/nginx/blockbots/whitelist-domains.conf|"${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/whitelist-domains.conf|g" \
                -e "s|/container/data/nginx/blockbots/whitelist-ips.conf|"${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/whitelist-ips.conf|g" \
            /container/data/nginx/blockbots/globalblacklist.conf && \

        for block_file in \
                            bad-referrer-words \
                            blacklist-ips \
                            blacklist-user-agents \
                            custom-bad-referrers \
                            whitelist-ips \
                            whitelist-domains \
                        ; do
            if [ ! -f "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/"${block_file}" ]; then
                cp -R /container/data/nginx/blockbots/"${block_file}".conf "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"
            fi
        done
        if [ -d "/container/data/nginx/blockbots-custom" ] ; then
            print_notice "Detected Custom Bot Blocking configuration"
            cp -R /container/data/nginx/blockbots-custom/* "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"
        fi

        if [ -n "${NGINX_BLOCK_BOTS_WHITELIST_DOMAIN}" ]; then
            whitelist_domains=$(echo "${NGINX_BLOCK_BOTS_WHITELIST_DOMAIN,,}" | tr "," "\n")
            for wl_domain in ${whitelist_domains}; do
                wl_domain_orig=${wl_domain}
                wl_domain="$(echo "${wl_domain}" | sed "s|\\.|\\\.|g" | sed "s|-|\\\-|g")"
                if ! grep -q "${wl_domain_orig}" "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/whitelist-domains.conf ; then
                    print_debug  "Adding '${wl_domain_orig}' domain to bot blocker whitelist"
                    echo '"~*(?:\b)'$(echo "${wl_domain}")'(?:\b)" 0;' $(echo " # ${wl_domain_orig} automatically added on") $(date +"%Y-%m-%d-%H:%M:%S") | silent tee -a ${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}/whitelist-domains.conf
                else
                    print_debug "[server_configure_blockbots] Skipping '${wl_domain_orig}' to be added to bot blocker domain whitelist"
                fi
            done
        fi

        if [ -n "${NGINX_BLOCK_BOTS_WHITELIST_IP}" ]; then
            whitelist_ips=$(echo "${NGINX_BLOCK_BOTS_WHITELIST_IP}" | tr "," "\n")
            for wl_ip in ${whitelist_ips}; do
                if ! grep -q "${wl_ip}" "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/whitelist-ips.conf ; then
                    print_debug  "Adding IP: '${wl_ip}' to bot blocker whitelist"
                    echo "${wl_ip} 0; # Automatically added on $(date +"%Y-%m-%d-%H:%M:%S")" | silent tee -a "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/whitelist-ips.conf
                else
                    print_debug "[server_configure_blockbots] Skipping IP: '${wl_ip}' from being added to bot blocker IP whitelist"
                fi
            done
        fi

        if [ -n "${NGINX_BLOCK_BOTS}" ] ; then
            if [[ "${NGINX_BLOCK_BOTS,}" == *"all" ]] ; then
                NGINX_BLOCK_BOTS=ALL
            fi

            IFS=","
            for bot in ${NGINX_BLOCK_BOTS} ; do
                case "${bot,,}" in
                    "all" )
                        nginx_block_bots="adidxbot,aolbuild,bingbot,bingpreview,DoCoMo,duckduckgo,facebookexternalhit,facebookplatform,AdsBot-Google,Googlebot,Googlebot-Image,Googlebot-Mobile,Googlebot-News,Googlebot/Test,Googlebot-Video,Google-HTTP-Java-Client,LinkedInBot,Gravityscan,Jakarta\\ Commons,Kraken/0.1,teoma,msnbot,msnbot-media,SAMSUNG,Slackbot,Slackbot-LinkExpanding,slurp,TwitterBot,Wordpress,yahoo"
                    ;;
                    "aol" )
                        nginx_block_bots="aolbuild,${nginx_block_bots}"
                    ;;
                    "bing" )
                        nginx_block_bots="bingbot,bingpreview,${nginx_block_bots}"
                    ;;
                    "docomo" )
                        nginx_block_bots="DoCoMo,${nginx_block_bots}"
                    ;;
                    "duckduckgo" )
                        nginx_block_bots="duckduckgo,${nginx_block_bots}"
                    ;;
                    "facebook" )
                        nginx_block_bots="developers.facebook.com,facebookexternalhit,facebookplatform,${nginx_block_bots}"
                    ;;
                    "google" )
                        nginx_block_bots="AdsBot-Google,Googlebot,Googlebot-Image,Googlebot-Mobile,Googlebot-News,Googlebot/Test,Googlebot-Video,Google-HTTP-Java-Client,${nginx_block_bots}"
                    ;;
                    "linkedin" )
                        nginx_block_bots="LinkedInBot,${nginx_block_bots}"
                    ;;
                    "misc" )
                        nginx_block_bots="adidxbot,Gravityscan,'Jakarta\ Commons',Kraken/0.1,teoma,${nginx_block_bots}"
                    ;;
                    "msn" )
                        nginx_block_bots="msnbot,msnbot-media,${nginx_block_bots}"
                    ;;
                    "samsung" )
                        nginx_block_bots="SAMSUNG,${nginx_block_bots}"
                    ;;
                    "slack" )
                        nginx_block_bots="Slackbot,Slackbot-LinkExpanding,${nginx_block_bots}"
                    ;;
                    "slurp" )
                        nginx_block_bots="slurp,${nginx_block_bots}"
                    ;;
                    "twitter" )
                        nginx_block_bots="TwitterBot,${nginx_block_bots}"
                    ;;
                    "wordpress" )
                        nginx_block_bots="Wordpress,${nginx_block_bots}"
                    ;;
                    "yahoo" )
                        nginx_block_bots="yahoo,${nginx_block_bots}"
                    ;;
                    * )
                        nginx_block_bots="${bot},${nginx_block_bots}"
                    ;;
                esac
            done

            NGINX_BLOCK_BOTS_BLACKLIST_USER_AGENTS="${nginx_block_bots}"
        fi

        if [ -n "${NGINX_BLOCK_BOTS_BLACKLIST_USER_AGENTS}" ]; then
            IFS=","
            for blacklist_ua in $NGINX_BLOCK_BOTS_BLACKLIST_USER_AGENTS; do
                blacklist_ua_orig="$(echo "${blacklist_ua}" | sed "s|\\\||g")"
                if ! grep -q "${blacklist_ua_orig}" "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/blacklist-user-agents.conf ; then
                    print_debug  "[server_configure_blockbots]  Adding UA: '${blacklist_ua_orig}' to bot blocker blacklist"
                    echo '"~*(?:\b)'$(echo "${blacklist_ua}")'(?:\b)" 3; # '${blacklist_ua_orig}' Automatically added on '$(date +"%Y-%m-%d-%H:%M:%S") | silent tee -a "${NGINX_BLOCKBOTS_CONFIG_CUSTOM_PATH%/}"/blacklist-user-agents.conf
                else
                    print_debug "[server_configure_blockbots] Skipping UA: '${blacklist_ua_orig}' from being added to bot blocker blacklist"
                fi
            done
        fi

        render_template /container/data/nginx/templates/server/server-botblocker.template \
                            "${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/botblocker.conf
        else
            local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/botblocker.conf
            silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_cache_open_file() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/http-cache-open_file.conf
    truefalse_onoff NGINX_CACHE_OPEN_FILE_ERRORS lowercase
    if var_true "${NGINX_ENABLE_CACHE_OPEN_FILE}" ; then
        render_template /container/data/nginx/templates/server/http-cache-open_file.template \
                        "${rendered_template}" \
                            NGINX_CACHE_OPEN_FILE_ERRORS \
                            NGINX_CACHE_OPEN_FILE_INACTIVE \
                            NGINX_CACHE_OPEN_FILE_MAX \
                            NGINX_CACHE_OPEN_FILE_MIN_USES \
                            NGINX_CACHE_OPEN_FILE_VALID
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_compression_brotli() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/compression-brotli.conf
    if var_true "${NGINX_ENABLE_COMPRESSION_BROTLI}" ; then
        render_template /container/data/nginx/templates/server/http-compression-brotli.template \
                        "${rendered_template}" \
                            NGINX_COMPRESSION_BROTLI_LEVEL \
                            NGINX_COMPRESSION_BROTLI_MIN_LENGTH \
                            NGINX_COMPRESSION_BROTLI_TYPES \
                            NGINX_COMPRESSION_BROTLI_WINDOW
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_compression_gzip() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/compression-gzip.conf
    truefalse_onoff NGINX_COMPRESSION_GZIP_VARY lowercase
    if var_true "${NGINX_ENABLE_COMPRESSION_GZIP}" ; then
        render_template /container/data/nginx/templates/server/http-compression-gzip.template \
                        "${rendered_template}" \
                            NGINX_COMPRESSION_GZIP_BUFFERS \
                            NGINX_COMPRESSION_GZIP_DISABLE \
                            NGINX_COMPRESSION_GZIP_HTTP_VERSION \
                            NGINX_COMPRESSION_GZIP_LEVEL \
                            NGINX_COMPRESSION_GZIP_MIN_LENGTH \
                            NGINX_COMPRESSION_GZIP_PROXIED \
                            NGINX_COMPRESSION_GZIP_TYPES \
                            NGINX_COMPRESSION_GZIP_VARY
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_ddos_protection() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/limit-ddos_protection.conf
    if var_true "${NGINX_ENABLE_DDOS_PROTECTION}" ; then
        render_template /container/data/nginx/templates/server/http-limit-ddos_protection.template \
                        "${rendered_template}" \
                            NGINX_DDOS_CONNECTIONS_PER_IP \
                            NGINX_DDOS_REQUESTS_PER_IP
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_includes() {
    local locations=(
        NGINX_SERVER_INCLUDE_CONFIGURATION_ROOT
        NGINX_SERVER_INCLUDE_CONFIGURATION_HTTP
        NGINX_SERVER_INCLUDE_CONFIGURATION_EVENTS
    )
    local folders=(
        .
        http
        events
    )

    for i in "${!locations[@]}"; do
        local ev="${locations[${i}]}"
        local dest_sub="${folders[${i}]}"
        local val="${!ev}"
        if [ -z "${val}" ]; then continue; fi
        local idx=1
        local rest="${val}"
        while [ -n "${rest}" ]; do
            local path="${rest%%,*}"
            rest="${rest#*,}"
            path="${path// /}"
            if [ -z "${path}" ]; then continue; fi
            if [ ! -e "${path}" ]; then
                print_warn "[server_configure] [includes] File not found: ${path} (for ${ev})"
                continue
            fi
            local fname="include$(printf '%02d' ${idx})-$(basename "${path}")"
            local dest_dir="${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/${dest_sub}"
            if [ "${dest_sub}" = "." ]; then dest_dir="${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d"; fi
            ln -sf "${path}" "${dest_dir}/${fname}"
            print_debug "[server_configure] [includes] Linked ${path} to ${dest_dir}/${fname}"
            idx=$((idx+1))
            if [ "${rest}" = "${path}" ]; then break ; fi
        done
    done
}

nginx_server_configure_metrics() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/metrics.conf
    export NGINX_VERSION="$(nginx -V 2>&1 | head -n1 | cut -d / -f 2)"
    if var_true "${NGINX_ENABLE_METRICS}" ; then
        render_template /container/data/nginx/templates/server/http-metrics.template \
                        "${rendered_template}" \
                            NGINX_VERSION
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_mimetypes() {
    local rendered_template="${NGINX_MIME_TYPES_PATH%/}"/"${NGINX_MIME_TYPES_FILE}"
    if [ ! -f "${rendered_template}" ]; then
        cp -a /container/data/nginx/templates/server/mime.types.template "${rendered_template}"
    fi
}

nginx_server_configure_proxy_buffering() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/proxy-buffer.conf
    truefalse_onoff NGINX_ENABLE_PROXY_BUFFERING lowercase
    if var_true "${NGINX_ENABLE_PROXY_BUFFERING}" ; then
        render_template /container/data/nginx/templates/server/http-proxy-buffer.template \
                        "${rendered_template}" \
                            NGINX_ENABLE_PROXY_BUFFERING \
                            NGINX_PROXY_BUFFERS \
                            NGINX_PROXY_BUFFER_SIZE \
                            NGINX_PROXY_BUSY_BUFFERS_SIZE
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_resolver() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/resolver.conf
    if [ -n "${NGINX_RESOLVER}" ]; then
        render_template /container/data/nginx/templates/server/http-resolver.template \
                        "${rendered_template}" \
                            NGINX_RESOLVER
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_reverse_proxy() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/headers-proxy.conf
    if var_true "${NGINX_ENABLE_REVERSE_PROXY}" ; then
        render_template /container/data/nginx/templates/server/http-headers-proxy.template \
                        "${rendered_template}" \
                            NGINX_REAL_IP_HEADER \
                            NGINX_SET_REAL_IP_FROM
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_tls() {
    local rendered_template="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/tls.conf
    local enable_tls=false

    if var_true "${NGINX_ENABLE_HTTPS}" ; then
        enable_tls=true
    else
        while read -r v; do
            local val
            val="${!v}"
            if var_true "${val}" ; then
                enable_tls=true
                break
            fi
        done < <(printenv | grep -E '^NGINX_SITE_.*_ENABLE_HTTPS=' | cut -d= -f1)
    fi

    if [ "${enable_tls}" = true ] ; then
        print_notice "[configure_tls] Configuring TLS Settings"

        truefalse_onoff NGINX_TLS_PREFER_SERVER_CIPHERS lowercase
        truefalse_onoff NGINX_TLS_VERIFY_CLIENT lowercase

        render_template "/container/data/nginx/templates/server/http-tls.template" \
                        "${rendered_template}" \
                            NGINX_TLS_ECDH_CURVE \
                            NGINX_TLS_CIPHERS \
                            NGINX_TLS_PREFER_SERVER_CIPHERS \
                            NGINX_TLS_PROTOCOLS \
                            NGINX_TLS_CLIENT_CERT_FILE \
                            NGINX_TLS_VERIFY_CLIENT \
                            NGINX_TLS_VERIFY_DEPTH \
                            NGINX_TLS_SESSION_CACHE \
                            NGINX_TLS_SESSION_TIMEOUT

        if [ "${NGINX_TLS_PROTOCOLS}" != "TLSv1.3" ] && [ -n "${NGINX_TLS_DH_PARAM_FILE}" ]; then
            if [ ! -f "${NGINX_TLS_DH_PARAM_FILE}" ] ; then
                print_notice "[configure_tls] Generating Diffie-Hellman parameters file at '${NGINX_TLS_DH_PARAM_FILE}'"
                create_folder "$(dirname "${NGINX_TLS_DH_PARAM_FILE}")" 755 "${NGINX_USER}":"${NGINX_GROUP}"
                silent openssl dhparam -out "${NGINX_TLS_DH_PARAM_FILE}" "${NGINX_TLS_DH_PARAM_BITS}"
            fi
            if [ -f "${NGINX_TLS_DH_PARAM_FILE}" ] && ! grep -q 'ssl_dhparam' "${rendered_template}"; then
                echo "ssl_dhparam ${NGINX_TLS_DH_PARAM_FILE};" | silent tee -a "${rendered_template}"
            fi
        fi
    else
        silent rm -f "${rendered_template}"
    fi
}

nginx_server_configure_tokens() {
    local headers_rendered="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/headers-server.conf
    if var_false "${NGINX_ENABLE_SERVER_TOKENS}"; then
        cp -a /container/data/nginx/templates/server/http-headers-server.template "${headers_rendered}"
    fi

    truefalse_onoff NGINX_ENABLE_SERVER_TOKENS lowercase
    local tokens_rendered="${NGINX_CONFIG_PATH%/}"/"${NGINX_CONFIG_FILE}".d/http/tokens.conf
    render_template /container/data/nginx/templates/server/http-tokens.template \
                    "${tokens_rendered}" \
                        NGINX_ENABLE_SERVER_TOKENS
}

nginx_site_configure_authentication() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local type_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_TYPE"
        local type_val
        type_val="$(resolve_site_var "${type_var}" "${NGINX_AUTHENTICATION_TYPE}" "${allow_defaults}")"
        type_val="${type_val,,}"
        if [ -z "${type_val}" ] || [ "${type_val}" = "none" ]; then
            print_debug "[configure_site/${_sitename}] [authentication] No authentication type set or 'none'. Skipping."
            return
        fi
        local title_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_TITLE"
        local title_val
        title_val="$(resolve_site_var "${title_var}" "${NGINX_AUTHENTICATION_TITLE}" "${allow_defaults}")"
        export _auth_title="${title_val}"
        case "${type_val}" in
            "basic")
                call nginx_authentication_configure_basic "${_sitename}" "${allow_defaults}"
            ;;
            "ldap")
                call nginx_authentication_configure_ldap "${_sitename}" "${allow_defaults}"
            ;;
            "llng")
                call nginx_authentication_configure_llng "${_sitename}" "${allow_defaults}"
            ;;
            *)
                print_warn "[configure_site/${_sitename}] [authentication] Unknown authentication type '${type_val}'. Skipping."
            ;;
        esac
    fi
}

nginx_site_configure_bootstrap() {
    if [ -n "${1}" ]; then
        local _sitename
        local _site_count="${2:-}"
        if [[ "${1}" == */* ]]; then
            _sitename="$(basename "${1%.*}")"
        else
            _sitename="${1}"
        fi

        if [ ! -f "${NGINX_CONFIG_PATH%/}/sites.available/${_sitename}.conf" ]; then
            print_debug "[configure_site/${_sitename}] Configuration file does not exist - auto-generating"
            write_file "${NGINX_CONFIG_PATH%/}"/sites.available/"${_sitename}".conf:644 <<EOF
include sites.enabled/${_sitename}/server-pre/*.conf;

server {
    include sites.enabled/${_sitename}/server-begin/*.conf;
    include sites.enabled/${_sitename}/location-pre/*.conf;
    include sites.enabled/${_sitename}/location/*.conf;
    include sites.enabled/${_sitename}/location-post/*.conf;
    include sites.enabled/${_sitename}/server-end/*.conf;
}

include sites.enabled/${_sitename}/server-post/*.conf;
EOF
        fi

        for fragment in server-pre server-begin location-pre location location-post server-end server-post; do
            create_folder "${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${fragment}" "${NGINX_USER}:${NGINX_GROUP}" 755
        done

        _link_fragments_from() {
            local src_root="$1"
            [ -z "${src_root}" ] && return
            for fragment in server-pre server-begin location-pre location location-post server-end server-post; do
                local src_dir="${src_root%/}/${_sitename}/${fragment}"
                local dest_dir="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${fragment}"
                if [ -d "${src_dir}" ]; then
                    print_debug "[configure_site/${_sitename}] [bootstrap] Linking fragments from ${src_dir} to ${dest_dir}"
                    find "${src_dir%/}" -maxdepth 1 -type f -print0 2>/dev/null | while IFS= read -r -d '' f; do
                        silent ln -sf "${f}" "${dest_dir%/}/$(basename "${f}")"
                    done
                fi
            done
        }

        _link_fragments_from "/container/data/nginx/sites.available"
        _link_fragments_from "${NGINX_CONFIG_PATH%/}/sites.available"

        local site_count="${_site_count:-0}"

        if [ "${site_count}" -le 1 ]; then
            for fragment in server-pre server-begin location-pre location location-post server-end server-post; do
                local legacy_dir1="/container/data/nginx/${fragment}"
                local legacy_dir2="/container/data/nginx/${fragment%/*}/${fragment##*/}"
                local dest_dir="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${fragment}"
                if [ -d "${legacy_dir1}" ]; then
                    print_debug "[configure_site/${_sitename}] [bootstrap] Linking legacy fragments from ${legacy_dir1} to ${dest_dir}"
                    find "${legacy_dir1%/}" -maxdepth 1 -type f -print0 2>/dev/null | while IFS= read -r -d '' f; do
                        silent ln -sf "${f}" "${dest_dir%/}/$(basename "${f}")"
                    done
                elif [ -d "${legacy_dir2}" ]; then
                    print_debug "[configure_site/${_sitename}] [bootstrap] Linking legacy fragments from ${legacy_dir2} to ${dest_dir}"
                    find "${legacy_dir2%/}" -maxdepth 1 -type f -print0 2>/dev/null | while IFS= read -r -d '' f; do
                        silent ln -sf "${f}" "${dest_dir%/}/$(basename "${f}")"
                    done
                fi
            done
        fi
    fi
}

nginx_site_configure_cache_client() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_CLIENT_CACHE"
        local types_var="NGINX_SITE_${_sitename^^}_CLIENT_CACHE"
        local enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_CLIENT_CACHE}" "${allow_defaults}")"
        local types_val="$(resolve_site_var "${types_var}" "" "${allow_defaults}")"
        if ! var_true "${enable_val}" || [ -z "${types_val}" ]; then
            print_debug "[configure_site/${_sitename}] [client_cache] Skipping site ${_sitename}: not enabled or no types set"
            return
        fi
        local output=""
        echo "${types_val,,}" | tr ',' '\n' | while read -r ccc; do
            ccc_trimmed="$(echo "${ccc}" | xargs)"
            if [ -z "${ccc_trimmed}" ] ; then continue; fi
            local ext_var="NGINX_SITE_${_sitename^^}_CLIENT_CACHE_${ccc_trimmed^^}_EXTENSIONS"
            local log_var="NGINX_SITE_${_sitename^^}_CLIENT_CACHE_${ccc_trimmed^^}_LOG"
            local exp_var="NGINX_SITE_${_sitename^^}_CLIENT_CACHE_${ccc_trimmed^^}_EXPIRES"
            local extensions="${!ext_var}"
            local log_value="${!log_var}"
            local expires_value="${!exp_var}"
            if [ -z "${extensions}" ]; then
                ext_var="NGINX_CLIENT_CACHE_${ccc_trimmed^^}_EXTENSIONS"; extensions="${!ext_var}"
            fi
            if [ -z "${log_value}" ]; then
                log_var="NGINX_CLIENT_CACHE_${ccc_trimmed^^}_LOG"; log_value="${!log_var}"
            fi
            if [ -z "${expires_value}" ]; then
                exp_var="NGINX_CLIENT_CACHE_${ccc_trimmed^^}_EXPIRES"; expires_value="${!exp_var}"
            fi
            if [ -z "${extensions}" ]; then
                print_warn "[configure_site/${_sitename}] [client_cache] No extensions set for type '${ccc_trimmed}'. Skipping."
                continue
            fi
            case "${log_value,,}" in
                1|true|on|yes) log_value="on" ;;
                0|false|off|no) log_value="off" ;;
                *) log_value="off" ;;
            esac
            local extensions_pipe="${extensions//,/|}"
            export extensions extensions_pipe log_value expires_value
            local template_content
            template_content="$(cat /container/data/nginx/templates/site/location-client_cache.template)"
            local rendered_block
            rendered_block="$(eval "echo \"${template_content}\"")"
            print_debug "[configure_site/${_sitename}] [client_cache] Rendered block for ${ccc_trimmed}:\n${rendered_block}"
            coutput+="${rendered_block}\n"
        done
        printf "%b" "${coutput}" | silent tee "${NGINX_CONFIG_PATH%/}"/sites.enabled/${_sitename}/location-post/50-client_cache.conf
    fi
}

nginx_site_configure_fastcgi() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_FASTCGI_PARAMS"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_FASTCGI_PARAMS}" "${allow_defaults}")"
        if set -o posix ; set | grep -qE "^NGINX_SITE_${_sitename^^}_ENABLE_FASTCGI_PARAMS=" ; then
            site_has_explicit_enable=true
        else
            site_has_explicit_enable=false
        fi

        if [ -f "/container/functions/20-php-fpm" ]; then
            if [ "${site_has_explicit_enable}" = true ] && var_false "${enable_val}" ; then
                print_debug "[configure_site/${_sitename}] [fastcgi] PHP-FPM detected but site explicitly disabled fastcgi params"
            else
                enable_val=true
                print_debug "[configure_site/${_sitename}] [fastcgi] PHP-FPM detected — enabling fastcgi params"
            fi
        fi

        local auth_type_var="NGINX_SITE_${_sitename^^}_AUTHENTICATION_TYPE"
        local auth_type_val
        auth_type_val="$(resolve_site_var "${auth_type_var}" "${NGINX_AUTHENTICATION_TYPE:-}" "${allow_defaults}")"
        auth_type_val="${auth_type_val,,}"
        if [ "${auth_type_val}" = "llng" ]; then
            if [ "${site_has_explicit_enable}" = true ] && var_false "${enable_val}" ; then
                print_debug "[configure_site/${_sitename}] [fastcgi] LLNG auth requested but site explicitly disabled fastcgi params"
            else
                enable_val=true
                local llng_enabled=true
                print_debug "[configure_site/${_sitename}] [fastcgi] LLNG authentication requested — enabling fastcgi params"
            fi
        fi

        local site_param_var="NGINX_SITE_${_sitename^^}_FASTCGI_PARAMS_FILE"
        local site_param_val
        site_param_val="$(resolve_site_var "${site_param_var}" "${NGINX_FASTCGI_PARAMS_FILE:-}" "${allow_defaults}")"
        local param_file
        if [ -n "${site_param_val}" ]; then
            if [[ "${site_param_val}" = /* ]]; then
                param_file="${site_param_val}"
            else
                param_file="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${site_param_val}"
            fi
        else
            param_file="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/fastcgi_params"
        fi

        if var_nottrue "${enable_val}" ; then
            print_debug "[configure_site/${_sitename}] [fastcgi] FastCGI params disabled for site"
            silent rm -f "${param_file}"
            return
        fi

        create_folder "$(dirname "${param_file}")" "${NGINX_USER}:${NGINX_GROUP}" 750
                if [ ! -f "${param_file}" ]; then
            cp -a /container/data/nginx/params/fastcgi_params "${param_file}"
        fi

        local https_var="NGINX_SITE_${_sitename^^}_ENABLE_FASTCGI_HTTPS"
        local https_val
        https_val="$(resolve_site_var "${https_var}" "${NGINX_ENABLE_FASTCGI_HTTPS}" "${allow_defaults}")"
        truefalse_onoff https_val lowercase

        sed -i -e "s|fastcgi_param .* HTTPS .*;|fastcgi_param  HTTPS ${https_val};|g" "${param_file}"

        if var_true "${llng_enabled}"; then
            echo "include ${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/authentication/*-params;" | silent tee -a "${param_file}"
        fi

        site_main_conf="${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/${_sitename}.conf"
        site_folder="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/"
        escaped_param_file=$(printf '%s' "${param_file}" | sed -e 's/[\\&|]/\\\\&/g')
        if [ -f "${site_main_conf}" ]; then
            if grep -q "{{fastcgi_params}}" "${site_main_conf}" 2>/dev/null; then
                sed -i "s|{{fastcgi_params}}|include ${escaped_param_file}|g" "${site_main_conf}"
            fi
        fi

        if [ -d "${site_folder}" ]; then
            find -L "${site_folder}" -type f -print0 2>/dev/null | while IFS= read -r -d '' file; do
                if grep -q "{{fastcgi_params}}" "${file}" 2>/dev/null; then
                    sed -i "s|{{fastcgi_params}}|include ${escaped_param_file}|g" "${file}"
                fi
            done
        fi

        fastcginum_site=$(printenv | sort | grep -cE "^NGINX_SITE_${_sitename^^}_FASTCGI[0-9]{2}_PARAM=")
        for (( fastcgiparam = 1; fastcgiparam <= fastcginum_site; fastcgiparam++ )) ; do
            fastcgiparam_padded=$(printf "%02d" "${fastcgiparam}")
            fastcgiparam_value=$(printenv | grep -E "^NGINX_SITE_${_sitename^^}_FASTCGI${fastcgiparam_padded}_PARAM=" | cut -d = -f 2-)
            if [ -n "${fastcgiparam_value}" ]; then
                name=$(echo "${fastcgiparam_value}" | cut -d , -f1)
                val=$(echo "${fastcgiparam_value}" | cut -d , -f2-)
                echo "fastcgi_param     ${name}  ${val}" | silent tee -a "${param_file}"
            fi
        done
        if var_true "${allow_defaults}" ; then
            fastcginum_global=$(set -o posix; set | sort | grep -cE '^NGINX_FASTCGI[0-9]{2}_PARAM=')
            for (( fastcgiparam = 1; fastcgiparam <= fastcginum_global; fastcgiparam++ )) ; do
                fastcgiparam_padded=$(printf "%02d" "${fastcgiparam}")
                fastcgiparam_value=$(set -o posix; set | grep -E "^NGINX_FASTCGI${fastcgiparam_padded}_PARAM=" | cut -d = -f 2-)
                if [ -n "${fastcgiparam_value}" ]; then
                    name=$(echo "${fastcgiparam_value}" | cut -d , -f1)
                    val=$(echo "${fastcgiparam_value}" | cut -d , -f2-)
                    if ! grep -q -F "fastcgi_param     ${name}  ${val}" "${param_file}" 2>/dev/null; then
                        echo "fastcgi_param     ${name}  ${val}" | silent tee -a "${param_file}"
                    fi
                fi
            done
        fi
        print_debug "[configure_site/${_sitename}] [fastcgi] Enabled FastCGI params at ${param_file}"
    fi
}

nginx_site_configure_deny_hidden_files() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_DENY_HIDDEN_FILES"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_DENY_HIDDEN_FILES}" "${allow_defaults}")"
        if var_true "${enable_val,,}"; then
            print_notice "[configure_site/${_sitename}] [deny_hidden_files] Enabled denying access to hidden files"
            ln -sf /container/data/nginx/templates/site/location-deny_hidden_files.template "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/31-deny_hidden_files.conf
        fi
    fi
}

nginx_site_configure_disable_log_favicon() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_LOG_FAVICON"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_LOG_FAVICON}" "${allow_defaults}")"
        if var_false "${enable_val,,}"; then
            print_notice "[configure_site/${_sitename}] [disable_log_favicon] Disabled logging of favicon"
            ln -sf /container/data/nginx/templates/site/location-disable_log_favicon.template "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/33-disable_log_favicon.conf
        fi
    fi
}

nginx_site_configure_disable_log_robots() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_LOG_ROBOTS"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_LOG_ROBOTS}" "${allow_defaults}")"
        if var_false "${enable_val,,}"; then
            print_notice "[configure_site/${_sitename}] [disable_log_robots] Disabled logging of robots.txt"
            ln -sf "/container/data/nginx/templates/site/location-disable_log_robots.template" "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/32-disable_log_robots.conf
        fi
    fi
}

nginx_site_configure_enable_symlinks() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_SYMLINKS"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_SYMLINKS}" "${allow_defaults}")"
        if var_true "${enable_val,,}"; then
            print_notice "[configure_site/${_sitename}] [enable_symlinks] Enabled following of symlinks"
            ln -sf /container/data/nginx/templates/site/server-symlinks.template "${NGINX_CONFIG_PATH%/}"/sites.enabled/${_sitename}/server-begin/30-symlinks.conf
        fi
    fi
}

nginx_site_configure_exploit_protection() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_EXPLOIT_PROTECTION"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_EXPLOIT_PROTECTION}" "${allow_defaults}")"
        if var_true "${enable_val}" ; then
            print_notice "[configure_site/${_sitename}] [exploit_protection] Enabled exploit protection"
            local blocked_path_var="NGINX_SITE_${_sitename^^}_LOG_BLOCKED_PATH"
            local blocked_file_var="NGINX_SITE_${_sitename^^}_LOG_BLOCKED_FILE"
            local blocked_format_var="NGINX_SITE_${_sitename^^}_LOG_BLOCKED_FORMAT"
            local _site_log_blocked_path="${!blocked_path_var:-$NGINX_LOG_BLOCKED_PATH}"
            local _site_log_blocked_file="${!blocked_file_var:-$NGINX_LOG_BLOCKED_FILE}"
            local _site_log_blocked_format="${!blocked_format_var:-$NGINX_LOG_BLOCKED_FORMAT}"
            export _site_log_blocked_path _site_log_blocked_file _site_log_blocked_format
            render_template \
                "/container/data/nginx/templates/site/location-exploit_protection.template" \
                "${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/location-pre/30-exploit_protection.conf" \
                    _site_log_blocked_path \
                    _site_log_blocked_file \
                    _site_log_blocked_format
        fi
    fi
}

nginx_site_configure_headers() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_HEADERS"
        local enable_val="${!enable_var}"
        if [ -z "${enable_val}" ] && var_true "${allow_defaults}"; then enable_val="${NGINX_ENABLE_HEADERS}"; fi
        if ! var_true "${enable_val}"; then
            print_debug "[configure_site/${_sitename}] [headers] Headers not enabled for site ${_sitename}"
            return
        fi
        local houtput=""
        local site_prefix="NGINX_SITE_${_sitename^^}_HEADER_"
        local header_vars
        header_vars=$(printenv | grep -E "^${site_prefix}.*_NAME=" | cut -d= -f1 | sort)
        for nv in ${header_vars}; do
            local base="${nv%_NAME}"
            local hn="${!nv}"
            local hv_var="${base}_VALUE"
            local hf_var="${base}_FLAG"
            local hv="${!hv_var}"
            local hf="${!hf_var}"
            if [ -z "${hn}" ] || [ -z "${hv}" ]; then continue; fi
            case "${hn,,}" in none|false|unset|null) continue ;; esac
            local hve="$(echo "${hv}" | sed 's/"/\\"/g')"
            houtput+="add_header ${hn} \"${hve}\"${hf:+ ${hf}};\n"
            print_debug "[configure_site/${_sitename}] [headers] Added header '${hn}'"
        done
        if [ -z "${houtput}" ]; then
            print_debug "[configure_site/${_sitename}] [headers] No per-site headers found. Skipping."
            return
        fi
        printf "%b" "${houtput}" | silent tee "${NGINX_CONFIG_PATH%/}"/sites.enabled/${_sitename}/location-pre/10-headers.conf
    fi
}

nginx_site_configure_includes() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local locations=(
            LOCATION LOCATION_PRE LOCATION_POST SERVER_BEGIN SERVER_END SERVER_PRE SERVER_POST
        )
        local folders=(
            location location-pre location-post server-begin server-end server-pre server-post
        )
        for i in "${!locations[@]}"; do
            local loc="${locations[${i}]}"
            local folder="${folders[${i}]}"
            local var_site="NGINX_${_sitename^^}_INCLUDE_CONFIGURATION_${loc}"
            local var_global="NGINX_INCLUDE_CONFIGURATION_${loc}"
            local val
            val="$(resolve_site_var "${var_site}" "${!var_global}" "${allow_defaults}")"
            if [ -n "${val}" ]; then
                local idx=1
                local rest="${val}"
                while [ -n "${rest}" ]; do
                    local path="${rest%%,*}"
                    rest="${rest#*,}"
                    path="${path// /}"
                    if [ -z "${path}" ]; then continue; fi
                    if [ ! -e "${path}" ]; then
                        print_warn "[configure_site/${_sitename}] [includes] File not found: ${path} (for ${loc})"
                        continue
                    fi
                    local fname="include$(printf '%02d' ${idx})-$(basename "${path}")"
                    local dest_path="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${folder}"
                    ln -sf "${path}" "${dest_path}/${fname}"
                    print_debug "[configure_site/${_sitename}] [includes] Linked ${path} to ${dest_path}/${fname}"
                    idx=$((idx+1))
                    if [ "${rest}" = "${path}" ]; then break ; fi
                done
            fi
        done
    fi
}

nginx_site_configure_listener() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        if [ -z "${allow_defaults}" ]; then allow_defaults=true; fi

        local http_enabled_var="NGINX_SITE_${_sitename^^}_ENABLE_HTTP"
        local http_enabled
        http_enabled="$(resolve_site_var "${http_enabled_var}" "${NGINX_ENABLE_HTTP}" "${allow_defaults}")"

        local https_enabled_var="NGINX_SITE_${_sitename^^}_ENABLE_HTTPS"
        local https_enabled
        https_enabled="$(resolve_site_var "${https_enabled_var}" "${NGINX_ENABLE_HTTPS}" "${allow_defaults}")"

        if  var_nottrue "${http_enabled}" &&  var_nottrue "${https_enabled}" &&  var_nottrue "${allow_defaults}"; then
            print_warn "[configure_site/${_sitename}] [listener] Both HTTP and HTTPS are disabled and ALLOW_DEFAULTS is false. This site will not be served."
            exit 1
        fi

        if var_true "${http_enabled}"; then
            local http_port_var="NGINX_SITE_${_sitename^^}_HTTP_LISTEN_PORT"
            local http_port="${!http_port_var}"
            if [ -z "${http_port}" ] && var_true "${allow_defaults}"; then
                http_port="${NGINX_HTTP_LISTEN_PORT:-${NGINX_LISTEN_PORT}}"
            fi
            if [ -n "${http_port}" ]; then
                local http_extra_var="NGINX_SITE_${_sitename^^}_HTTP_EXTRA"
                local http_extra="${!http_extra_var}"
                local http_to_https_var="NGINX_SITE_${_sitename^^}_ENABLE_HTTP_TO_HTTPS"
                local http_to_https_val="${!http_to_https_var}"
                http_to_https_val="$(resolve_site_var "${http_to_https_var}" "${NGINX_ENABLE_HTTP_TO_HTTPS}" "${allow_defaults}")"
                if var_true "${http_enabled}" && var_true "${https_enabled}" && var_true "${http_to_https_val}"; then
                    local server_name_var="NGINX_SITE_${_sitename^^}_SERVER_NAME"
                    local server_name
                    server_name="$(resolve_site_var "${server_name_var}" "${NGINX_SERVER_NAME}" "${allow_defaults}")"
                    if [ -z "${server_name}" ]; then  server_name="_"; fi
                    http_extra="return 301 https://\$host\$request_uri;${http_extra:+\n$http_extra}"
                fi
                local _site_http_port="${http_port}"
                local _site_http_listen="listen ${http_port};"
                local _site_http_extras="${http_extra}"
                export _site_http_port _site_http_listen _site_http_extras
                render_template \
                                /container/data/nginx/templates/site/server-listen-http.template \
                                "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/10-http.conf \
                                    _site_http_listen \
                                    _site_http_port \
                                    _site_http_extras
                chmod 644 "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/10-http.conf
            fi
        fi

        if var_true "${https_enabled}"; then
            local https_port_var="NGINX_SITE_${_sitename^^}_HTTPS_LISTEN_PORT"
            local https_port="${!https_port_var}"
            if [ -z "${https_port}" ] ; then
                https_port="$(resolve_site_var "${https_port_var}" "${NGINX_HTTPS_LISTEN_PORT:-${NGINX_LISTEN_PORT}}" "${allow_defaults}")"
            fi
            local https_cert_var="NGINX_SITE_${_sitename^^}_TLS_CERT_FILE"
            local https_key_var="NGINX_SITE_${_sitename^^}_TLS_KEY_FILE"
            local https_cert="${!https_cert_var:-$NGINX_TLS_CERT_FILE}"
            local https_key="${!https_key_var:-$NGINX_TLS_KEY_FILE}"
            local create_selfsigned_var="NGINX_SITE_${_sitename^^}_TLS_CREATE_SELFSIGNED"
            local create_selfsigned_val
            create_selfsigned_val="$(resolve_site_var "${create_selfsigned_var}" "${NGINX_TLS_CREATE_SELFSIGNED:-${NGINX_TLS_GENERATE_SELFSIGNED}}" "${allow_defaults}")"
            ## TODO ACME
            if [ -n "${https_cert}" ] && [ -n "${https_key}" ]; then
                if [ ! -f "${https_cert}" ] || [ ! -f "${https_key}" ]; then
                    if var_true "${create_selfsigned_val}" ; then
                        print_notice "[configure_site/${_sitename}] [https] TLS cert/key missing - Generating self-signed cert"
                        create_folder \
                                        "$(dirname "${https_cert}"), \
                                         $(dirname "${https_key}")" \
                                         root:root 755
                        silent openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                            -keyout "${https_key}" -out "${https_cert}" \
                            -subj "/CN=${_sitename}" >/dev/null 2>&1
                        silent chown root:root "${https_cert}" "${https_key}"
                        silent chmod 644 "${https_cert}"
                        silent chmod 600 "${https_key}"
                    else
                        print_error "[configure_site/${_sitename}] [https] TLS certificate or key not found and self signed generation disabled. Exiting."
                        exit 1
                    fi
                fi
            fi
            if [ -n "${https_port}" ] && [ -n "${https_cert}" ] && [ -n "${https_key}" ]; then
                local https_extra_var="NGINX_SITE_${_sitename^^}_TLS_EXTRA"
                local https_extra="${!https_extra_var}"
                local _site_https_port="${https_port}"

                local http2_var="NGINX_SITE_${_sitename^^}_ENABLE_HTTP2"
                local http2_val
                http2_val="$(resolve_site_var "${http2_var}" "${NGINX_ENABLE_HTTP2}" "${allow_defaults}")"
                if var_true "${http2_val}" ; then
                    local _site_https_listen="listen ${https_port} ssl;"
                    local _site_http2="http2 on;"
                else
                    local _site_https_listen="listen ${https_port} ssl;"
                    local _site_http2=""
                fi

                local http3_var="NGINX_SITE_${_sitename^^}_ENABLE_HTTP3"
                local http3_val
                http3_val="$(resolve_site_var "${http3_var}" "${NGINX_ENABLE_HTTP3}" "${allow_defaults}")"
                local _site_https_listen_quic=""
                if var_true "${http3_val}" ; then
                    _site_https_listen_quic="listen ${https_port} quic reuseport;"
                fi

                local _site_https_extras="${https_extra}"
                local _site_https_cert="${https_cert}"
                local _site_https_key="${https_key}"
                export _site_https_port _site_https_listen _site_http2 _site_https_listen_quic _site_https_extras _site_https_cert _site_https_key
                render_template \
                                /container/data/nginx/templates/site/server-listen-https.template \
                                "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/11-https.conf \
                                    _site_https_listen \
                                    _site_https_listen_quic \
                                    _site_http2 \
                                    _site_https_port \
                                    _site_https_cert \
                                    _site_https_key \
                                    _site_https_extras
                chmod 644 "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/11-https.conf
            fi
        fi
    fi
}

nginx_site_configure_logging() {
    if [ -n "${1}" ] ; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local _envprefix="NGINX_SITE_${_sitename^^}_LOG_"
        local _siteconfig_path="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/server-begin"

        local _access_file_v="${_envprefix}ACCESS_FILE"
        local _access_path_v="${_envprefix}ACCESS_PATH"
        local _access_format_v="${_envprefix}ACCESS_FORMAT"
        local _error_file_v="${_envprefix}ERROR_FILE"
        local _error_path_v="${_envprefix}ERROR_PATH"
        local _error_level_v="${_envprefix}LEVEL_ERROR"
        local _blocked_file_v="${_envprefix}BLOCKED_FILE"
        local _blocked_path_v="${_envprefix}BLOCKED_PATH"
        local _blocked_format_v="${_envprefix}BLOCKED_FORMAT"

        local _access_file="$(resolve_site_var "${_access_file_v}" "${NGINX_LOG_ACCESS_FILE}" "${allow_defaults}")"
        local _access_path="$(resolve_site_var "${_access_path_v}" "${NGINX_LOG_ACCESS_PATH}" "${allow_defaults}")"
        local _access_format="$(resolve_site_var "${_access_format_v}" "${NGINX_LOG_ACCESS_FORMAT}" "${allow_defaults}")"
        local _error_file="$(resolve_site_var "${_error_file_v}" "${NGINX_LOG_ERROR_FILE}" "${allow_defaults}")"
        local _error_path="$(resolve_site_var "${_error_path_v}" "${NGINX_LOG_ERROR_PATH}" "${allow_defaults}")"
        local _error_level="$(resolve_site_var "${_error_level_v}" "" "${allow_defaults}")"
        local _blocked_file="$(resolve_site_var "${_blocked_file_v}" "${NGINX_LOG_BLOCKED_FILE}" "${allow_defaults}")"
        local _blocked_path="$(resolve_site_var "${_blocked_path_v}" "${NGINX_LOG_BLOCKED_PATH}" "${allow_defaults}")"

        local site_count=0
        if [ -n "${NGINX_SITE_ENABLED}" ]; then
            site_count=0
            for s in $(echo "${NGINX_SITE_ENABLED}" | tr ',' '\n'); do
                if [ -n "${s// }" ] ; then site_count=$((site_count+1)); fi
            done
        fi

        local site_log_set=false
        for v in ACCESS_FILE ACCESS_PATH ACCESS_FORMAT ERROR_FILE ERROR_PATH LEVEL_ERROR BLOCKED_FILE BLOCKED_PATH BLOCKED_FORMAT; do
            val="${_envprefix}${v}"
            if [ -n "${!val}" ] && ! is_null "${!val}"; then
                site_log_set=true
                break
            fi
        done

        local _access_log_file _error_log_file _blocked_log_file
        if [ "${site_count}" -gt 1 ] || var_true "${site_log_set}" ; then
            _access_log_file="${_access_path%/}/${_sitename}-${_access_file}"
            _error_log_file="${_error_path%/}/${_sitename}-${_error_file}"
            _blocked_log_file="${_blocked_path%/}/${_sitename}-${_blocked_file}"
        else
            _access_log_file="${_access_path%/}/${_access_file}"
            _error_log_file="${_error_path%/}/${_error_file}"
            _blocked_log_file="${_blocked_path%/}/${_blocked_file}"
        fi

        create_folder "${_access_path}" "${NGINX_USER}:${NGINX_GROUP}" 750
        create_folder "${_error_path}" "${NGINX_USER}:${NGINX_GROUP}" 750

        s6-setuidgid "${NGINX_USER}" touch "${_access_log_file}"
        s6-setuidgid "${NGINX_USER}" touch "${_error_log_file}"

        if [ "${_access_log_file%/}" != "/dev/null" ]; then
            create_logrotate "nginx-access-${_sitename}" "${_access_log_file}" "nginx-${_access_format}" "${NGINX_USER}" "${NGINX_GROUP}"
        fi
        if [ "${_error_log_file%/}" != "/dev/null" ]; then
            create_logrotate "nginx-error-${_sitename}" "${_error_log_file}" "nginx-error-${_error_level}" "${NGINX_USER}" "${NGINX_GROUP}"
        fi

        local _exploit_site_var="NGINX_SITE_${_sitename^^}_ENABLE_EXPLOIT_PROTECTION"
        local _exploit_enabled
        _exploit_enabled="$(resolve_site_var "${_exploit_site_var}" "${NGINX_ENABLE_EXPLOIT_PROTECTION}" "${allow_defaults}")"
        if var_true "${_exploit_enabled}" ; then
            if [ "${_blocked_log_file%/}" != "/dev/null" ]; then
                create_folder "${_blocked_path}" "${NGINX_USER}:${NGINX_GROUP}" 750
                s6-setuidgid "${NGINX_USER}" touch "${_blocked_log_file}"
                create_logrotate "nginx-blocked-${_sitename}" "${_blocked_log_file}" "nginx-blocked-blocked" "${NGINX_USER}" "${NGINX_GROUP}"
            fi
        fi
        {
            echo "access_log   ${_access_log_file}  ${_access_format};"
            if [ -n "${_error_level}" ]; then
                echo "error_log    ${_error_log_file}   ${_error_level};"
            else
                echo "error_log    ${_error_log_file};"
            fi
        } | silent tee "${_siteconfig_path}/30-logging.conf"
        print_debug "[configure_site/${_sitename}] [logging] Wrote logging to ${_siteconfig_path}/30-logging.conf"
    fi
}

nginx_site_configure_maintenance() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local site_type_var="NGINX_SITE_${_sitename^^}_MAINTENANCE_TYPE"
        local site_file_var="NGINX_SITE_${_sitename^^}_MAINTENANCE_FILE"
        local site_path_var="NGINX_SITE_${_sitename^^}_MAINTENANCE_PATH"
        local site_proxy_var="NGINX_SITE_${_sitename^^}_MAINTENANCE_PROXY_URL"
        local site_redirect_var="NGINX_SITE_${_sitename^^}_MAINTENANCE_REDIRECT_URL"

        local maintenance_type
        maintenance_type="$(resolve_site_var "${site_type_var}" "${NGINX_MAINTENANCE_TYPE}" "${allow_defaults}")"
        maintenance_type="${maintenance_type,,}"

        if [ -z "${maintenance_type}" ] || [ "${maintenance_type}" = "none" ]; then
            print_debug "[configure_site/${_sitename}] [maintenance] No maintenance type set or 'none'. Skipping."
            return
        fi

        case "${maintenance_type,,}" in
            proxy)
                    local mproxy
                    mproxy="$(resolve_site_var "${site_proxy_var}" "${NGINX_MAINTENANCE_PROXY_URL}" "${allow_defaults}")"
                    if [ -z "${mproxy}" ]; then
                        print_error "[configure_site/${_sitename}] [maintenance/proxy] No maintenance proxy URL set. Exiting."
                        exit 1
                    fi
                    export proxy_url="${mproxy}"
                    render_template /container/data/nginx/templates/site/location-proxy.template \
                                    "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/50-maintenance.conf \
                                        proxy_url
                    print_notice "[configure_site/${_sitename}] [maintenance/proxy] Proxying maintenance to '${proxy_url}'"
            ;;
            redirect)
                local mredirect
                mredirect="$(resolve_site_var "${site_redirect_var}" "${NGINX_MAINTENANCE_REDIRECT_URL}" "${allow_defaults}")"
                if [ -z "${mredirect}" ]; then
                    print_error "[configure_site/${_sitename}] [maintenance/redirect] No maintenance redirect URL set. Exiting."
                    exit 1
                fi
                export redirect_url="${mredirect}"
                render_template /container/data/nginx/templates/site/location-redirect.template \
                                "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/50-maintenance.conf \
                                    redirect_url
                print_notice "[configure_site/${_sitename}] [maintenance/redirect] Redirecting to '${redirect_url}'"
            ;;
            local | * )
                    local mfile mpath mremote
                    mfile="$(resolve_site_var "${site_file_var}" "${NGINX_MAINTENANCE_FILE}" "${allow_defaults}")"
                    mpath="$(resolve_site_var "${site_path_var}" "${NGINX_MAINTENANCE_PATH}" "${allow_defaults}")"
                    local site_remote_var="NGINX_SITE_${_sitename^^}_MAINTENANCE_REMOTE_URL"
                    mremote="$(resolve_site_var "${site_remote_var}" "${NGINX_MAINTENANCE_REMOTE_URL}" "${allow_defaults}")"
                if [ -z "${mfile}" ] || [ -z "${mpath}" ]; then
                    print_error "[configure_site/${_sitename}] [maintenance/local] Missing maintenance file or path. Exiting."
                    exit 1
                fi
                if [ -n "${mremote}" ]; then
                    local download_dir="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/maintenance"
                    create_folder "${download_dir%/}" "${NGINX_USER}:${NGINX_GROUP}" 755
                    if [ ! -f "${download_dir%/}/${mfile}" ]; then
                        silent curl -sSL -o "${download_dir%/}/${mfile}" "${mremote}" || { print_error "[configure_site/${_sitename}] [maintenance/local] Failed to download remote maintenance file from ${mremote}"; exit 1; }
                        print_notice "[configure_site/${_sitename}] [maintenance/local] Downloaded remote maintenance file from '${mremote}' to '${download_dir%/}/${mfile}'"
                    else
                        print_notice "[configure_site/${_sitename}] [maintenance/local] Using existing downloaded maintenance file at '${download_dir%/}/${mfile}'"
                    fi
                    mpath="${download_dir%/}"
                fi

                export maintenance_file="${mfile}"
                export maintenance_path="${mpath}"
                render_template /container/data/nginx/templates/site/server-maintenance.template \
                                "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/50-maintenance.conf \
                                    maintenance_path \
                                    maintenance_file
                print_notice "[configure_site/${_sitename}] [maintenance/local] Enabled local maintenance page"
            ;;

        esac
    fi
}

nginx_site_configure_proxy() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local site_var="NGINX_SITE_${_sitename^^}_PROXY_URL"
        if [ -v "${site_var}" ]; then
            transform_var env "${site_var}"
        elif var_true "${allow_defaults}" && [ -v "NGINX_PROXY_URL" ]; then
            transform_var env NGINX_PROXY_URL
        fi
        local proxy_val
        proxy_val="$(resolve_site_var "${site_var}" "${NGINX_PROXY_URL}" "${allow_defaults}")"

        if [ -n "${proxy_val}" ]; then
            export proxy_url="${proxy_val}"
            render_template /container/data/nginx/templates/site/location-proxy.template \
                            "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/50-proxy.conf \
                                proxy_url
            print_notice "[configure_site/${_sitename}] [proxy] Setting access to '/' to proxy to '${proxy_url}'"
        else
            print_error "[configure_site/${_sitename}] [proxy] No proxy URL set and no default available. Exiting."
            exit 1
        fi
    fi
}

nginx_site_configure_redirect() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local site_var="NGINX_SITE_${_sitename^^}_REDIRECT_URL"
        if [ -v "${site_var}" ]; then
            transform_var env "${site_var}"
        elif var_true "${allow_defaults}" && [ -v "NGINX_REDIRECT_URL" ]; then
            transform_var env NGINX_REDIRECT_URL
        fi
        local redirect_val
        redirect_val="$(resolve_site_var "${site_var}" "${NGINX_REDIRECT_URL}" "${allow_defaults}")"

        if [ -n "${redirect_val}" ]; then
            export redirect_url="${redirect_val}"
            render_template /container/data/nginx/templates/site/location-redirect.template \
                            "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/31-redirect.conf \
                                redirect_url
            print_notice "[configure_site/${_sitename}] [redirect] Set all access to redirect to '${redirect_url}'"
        else
            print_error "[configure_site/${_sitename}] [redirect] No redirect URL set and no default available. Exiting."
            exit 1
        fi
    fi
}

nginx_site_configure_scgi() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_SCGI_PARAMS"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_SCGI_PARAMS}" "${allow_defaults}")"

        local site_param_var="NGINX_SITE_${_sitename^^}_SCGI_PARAMS_FILE"
        local site_param_val
        site_param_val="$(resolve_site_var "${site_param_var}" "${NGINX_SCGI_PARAMS_FILE:-}" "${allow_defaults}")"
        local param_file
        if [ -n "${site_param_val}" ]; then
            if [[ "${site_param_val}" = /* ]]; then
                param_file="${site_param_val}"
            else
                param_file="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${site_param_val}"
            fi
        else
            param_file="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/scgi_params"
        fi

        if var_nottrue "${enable_val}" ; then
            print_debug "[configure_site/${_sitename}] [scgi] SCGI params disabled for site"
            silent rm -f "${param_file}"
            return
        fi

        create_folder "$(dirname "${param_file}")" "${NGINX_USER}:${NGINX_GROUP}" 755
        if [ ! -f "${param_file}" ]; then
            cp -a /container/data/nginx/params/scgi_params "${param_file}"
        fi

        local https_var="NGINX_SITE_${_sitename^^}_ENABLE_SCGI_HTTPS"
        local https_val
        https_val="$(resolve_site_var "${https_var}" "${NGINX_ENABLE_SCGI_HTTPS}" "${allow_defaults}")"
        truefalse_onoff "${https_val}" lowercase
        sed -i -e "s|scgi_param .* HTTPS .*;|scgi_param  HTTPS ${https_val};|g" "${param_file}"

        site_main_conf="${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/${_sitename}.conf"
        site_folder="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}"
        escaped_param_file=$(printf '%s' "${param_file}" | sed -e 's/[\\&|]/\\\\&/g')
        if [ -f "${site_main_conf}" ]; then
            if grep -q "{{scgi_params}}" "${site_main_conf}" 2>/dev/null; then
                sed -i "s|{{scgi_params}}|include ${escaped_param_file}|g" "${site_main_conf}"
            fi
        fi
        if [ -d "${site_folder}" ]; then
            find -L "${site_folder}" -type f -print0 2>/dev/null | while IFS= read -r -d '' file; do
                if grep -q "{{scgi_params}}" "${file}" 2>/dev/null; then
                    sed -i "s|{{scgi_params}}|include ${escaped_param_file}|g" "${file}"
                fi
            done
        fi

        print_debug "[configure_site/${_sitename}] [scgi] Enabled SCGI params at ${param_file}"
    fi
}

nginx_site_configure_server_name() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local name_var="NGINX_SITE_${_sitename^^}_SERVER_NAME"
        local name_val
        name_val="$(resolve_site_var "${name_var}" "${NGINX_SERVER_NAME}" "${allow_defaults}")"
        if [ -z "${name_val}" ] ; then name_val="_"; fi
        export site_server_name="${name_val}"
        render_template \
                        /container/data/nginx/templates/site/server-server_name.template \
                        "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/09-server_name.conf \
                            site_server_name
        chmod 644 "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/09-server_name.conf
        print_debug "[configure_site/${_sitename}] [server_name] Rendered server_name fragment"
    fi
}

nginx_site_configure_uwsgi() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_UWSGI_PARAMS"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_UWSGI_PARAMS}" "${allow_defaults}")"

        local site_param_var="NGINX_SITE_${_sitename^^}_UWSGI_PARAMS_FILE"
        local site_param_val
        site_param_val="$(resolve_site_var "${site_param_var}" "${NGINX_UWSGI_PARAMS_FILE:-}" "${allow_defaults}")"
        local param_file
        if [ -n "${site_param_val}" ]; then
            if [[ "${site_param_val}" = /* ]]; then
                param_file="${site_param_val}"
            else
                param_file="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/${site_param_val}"
            fi
        else
            param_file="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/uwsgi_params"
        fi

        if var_nottrue "${enable_val}" ; then
            print_debug "[configure_site/${_sitename}] [uwsgi] uWSGI params disabled for site"
            silent rm -f "${param_file}"
            return
        fi

        create_folder "$(dirname "${param_file}")" "${NGINX_USER}:${NGINX_GROUP}" 755
        if [ ! -f "${param_file}" ]; then
            cp -a /container/data/nginx/params/uwsgi_params "${param_file}"
        fi

        local https_var="NGINX_SITE_${_sitename^^}_ENABLE_UWSGI_HTTPS"
        local https_val
        https_val="$(resolve_site_var "${https_var}" "${NGINX_ENABLE_UWSGI_HTTPS}" "${allow_defaults}")"
        truefalse_onoff "${https_val}" lowercase
        sed -i -e "s|uwsgi_param .* HTTPS .*;|uwsgi_param  HTTPS ${https_val};|g" "${param_file}"

        site_main_conf="${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}.d/${_sitename}.conf"
        site_folder="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}"
        escaped_param_file=$(printf '%s' "${param_file}" | sed -e 's/[\\&|]/\\\\&/g')
        if [ -f "${site_main_conf}" ]; then
            if grep -q "{{uwsgi_params}}" "${site_main_conf}" 2>/dev/null; then
                sed -i "s|{{uwsgi_params}}|include ${escaped_param_file}|g" "${site_main_conf}"
            fi
        fi
        if [ -d "${site_folder}" ]; then
            find -L "${site_folder}" -type f -print0 2>/dev/null | while IFS= read -r -d '' file; do
                if grep -q "{{uwsgi_params}}" "${file}" 2>/dev/null; then
                    sed -i "s|{{uwsgi_params}}|include ${escaped_param_file}|g" "${file}"
                fi
            done
        fi

        print_debug "[configure_site/${_sitename}] [uwsgi] Enabled uWSGI params at ${param_file}"
    fi
}

nginx_site_configure_webroot_index() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"

        local site_root_site_var="SITE_${_sitename^^}_ROOT"
        local site_root_global_var="SITE_ROOT"
        local nginx_site_var="NGINX_SITE_${_sitename^^}_WEBROOT"
        local nginx_global_var="NGINX_WEBROOT"
        local final_root=""

        if [ -n "${!site_root_site_var}" ]; then
            final_root="${!site_root_site_var}"
            print_debug "[configure_site/${_sitename}] [webroot] Using ${site_root_site_var}=${final_root}"
        elif [ -n "${!site_root_global_var}" ]; then
            final_root="${!site_root_global_var}"
            print_debug "[configure_site/${_sitename}] [webroot] Using ${site_root_global_var}=${final_root}"
        elif [ -n "${!nginx_site_var}" ]; then
            final_root="${!nginx_site_var}"
            print_debug "[configure_site/${_sitename}] [webroot] Using ${nginx_site_var}=${final_root}"
        elif [ -n "${!nginx_global_var}" ]; then
            final_root="${!nginx_global_var}"
            print_debug "[configure_site/${_sitename}] [webroot] Using ${nginx_global_var}=${final_root}"
        fi

        if [ -n "${final_root}" ]; then
            local final_root_source=""
            if [ -n "${!site_root_site_var}" ]; then
                final_root_source="site_specific"
            elif [ -n "${!site_root_global_var}" ]; then
                final_root_source="site_global"
            elif [ -n "${!nginx_site_var}" ]; then
                final_root_source="nginx_site"
            else
                final_root_source="nginx_global"
            fi
            # Always export and persist SITE/NGINX webroot and user/group
            # values so downstream images/tools can rely on consistent names.
            export SITE_ROOT="${final_root}"
            export "SITE_${_sitename^^}_ROOT"="${final_root}"
            export NGINX_WEBROOT="${final_root}"
            export "NGINX_SITE_${_sitename^^}_WEBROOT"="${final_root}"

            local site_user_var="SITE_${_sitename^^}_USER"
            local site_group_var="SITE_${_sitename^^}_GROUP"
            if [ -n "${NGINX_USER:-}" ]; then
                export SITE_USER="${NGINX_USER}"
                export "${site_user_var}"="${NGINX_USER}"
                export NGINX_USER="${NGINX_USER}"
                export "NGINX_SITE_${_sitename^^}_USER"="${NGINX_USER}"
            fi
            if [ -n "${NGINX_GROUP:-}" ]; then
                export SITE_GROUP="${NGINX_GROUP}"
                export "${site_group_var}"="${NGINX_GROUP}"
                export NGINX_GROUP="${NGINX_GROUP}"
                export "NGINX_SITE_${_sitename^^}_GROUP"="${NGINX_GROUP}"
            fi

            local _env_args=()
            _env_args+=("SITE_ROOT=${final_root}")
            _env_args+=("SITE_${_sitename^^}_ROOT=${final_root}")
            _env_args+=("NGINX_WEBROOT=${final_root}")
            _env_args+=("NGINX_SITE_${_sitename^^}_WEBROOT=${final_root}")
            if [ -n "${NGINX_USER:-}" ]; then _env_args+=("NGINX_USER=${NGINX_USER}"); fi
            if [ -n "${NGINX_GROUP:-}" ]; then _env_args+=("NGINX_GROUP=${NGINX_GROUP}"); fi
            if [ -n "${NGINX_USER:-}" ]; then _env_args+=("NGINX_SITE_${_sitename^^}_USER=${NGINX_USER}"); fi
            if [ -n "${NGINX_GROUP:-}" ]; then _env_args+=("NGINX_SITE_${_sitename^^}_GROUP=${NGINX_GROUP}"); fi
            if [ -n "${SITE_USER:-}" ]; then _env_args+=("SITE_USER=${SITE_USER}"); fi
            if [ -n "${!site_user_var:-}" ]; then _env_args+=("${site_user_var}=${!site_user_var}"); fi
            if [ -n "${SITE_GROUP:-}" ]; then _env_args+=("SITE_GROUP=${SITE_GROUP}"); fi
            if [ -n "${!site_group_var:-}" ]; then _env_args+=("${site_group_var}=${!site_group_var}"); fi

            _container_run_env "${_env_args[@]}"
        fi

        local webroot_var="NGINX_SITE_${_sitename^^}_WEBROOT"
        local webroot_val
        webroot_val="$(resolve_site_var "${webroot_var}" "${NGINX_WEBROOT}" "${allow_defaults}")"
        if [ -z "${webroot_val}" ]; then
            if var_true "${allow_defaults}"; then
                webroot_val="${NGINX_WEBROOT}"
            else
                print_error "[configure_site/${_sitename}] [webroot] No webroot set and NGINX_SITE_${_sitename^^}_ALLOW_DEFAULTS is false."
                exit 1
            fi
        fi
        local webroot_suffix_var="NGINX_SITE_${_sitename^^}_WEBROOT_SUFFIX"
        local webroot_suffix
        webroot_suffix="$(resolve_site_var "${webroot_suffix_var}" "${NGINX_WEBROOT_SUFFIX}" "${allow_defaults}")"
        local _site_webroot_original="${webroot_val}"
        if [ -n "${webroot_suffix}" ]; then
            export site_webroot="${webroot_val}${webroot_suffix}"
        else
            export site_webroot="${webroot_val}"
        fi

        if [ -n "${webroot_val}" ]; then
            create_folder "${webroot_val%/}" "${NGINX_USER}:${NGINX_GROUP}" 750
        fi
        render_template \
                        /container/data/nginx/templates/site/server-webroot.template \
                        "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/20-webroot.conf \
                            site_webroot
        chmod 644 "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/20-webroot.conf
        print_debug "[configure_site/${_sitename}] [webroot] Rendered webroot fragment"
        export site_webroot="${_site_webroot_original}"

        local index_var="NGINX_SITE_${_sitename^^}_INDEX_FILE"
        local index_val
        index_val="$(resolve_site_var "${index_var}" "${NGINX_INDEX_FILE}" "${allow_defaults}")"
        export site_index="${index_val}"
        render_template \
                            /container/data/nginx/templates/site/server-index.template \
                            "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/server-begin/21-index.conf \
                        site_index
        chmod 644 "${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}/server-begin/21-index.conf"
        print_debug "[configure_site/${_sitename}] [index] Rendered index fragment"

        local index_file
        index_file=$(echo "${index_val}" | awk '{print $1}')
        local index_path="${webroot_val%/}/${index_file}"
        local enable_sample_var="NGINX_SITE_${_sitename^^}_CREATE_SAMPLE_HTML"
        local enable_sample_val
        enable_sample_val="$(resolve_site_var "${enable_sample_var}" "${NGINX_CREATE_SAMPLE_HTML:-${NGINX_ENABLE_CREATE_SAMPLE_HTML:-}}" "${allow_defaults}")"
        if [ -z "${enable_sample_val}" ] ; then enable_sample_val="false"; fi
        if var_true "${enable_sample_val}" && [ ! -f "${index_path}" ]; then
            print_notice "[configure_site/${_sitename}] [index] Creating sample ${index_file} for site at ${index_path}"
            create_folder "${webroot_val}" "${NGINX_USER}:${NGINX_GROUP}" 750
            write_file "${NGINX_USER}":"${NGINX_GROUP}" "${index_path}":644 <<EOF
<html>
<title>Default Page</title>
<h2>Container is working</h2>
Congratulations! Your ${IMAGE_NAME} image is working. You are seeing this because you don't have an ${index_val} file in your ${_sitename} ${webroot_val} directory. <p>

For more info visit <a href="https://www.nfrastack.com/?ref=container-nginx">https://www.nfrastack.com</a>
</html>
EOF
        fi
        call phpfpm_site_create_default_page "${_sitename}" "${webroot_val%/}" "${index_val}"

        local force_var="NGINX_SITE_${_sitename^^}_FORCE_RESET_PERMISSIONS"
        local force_val
        force_val="$(resolve_site_var "${force_var}" "${NGINX_FORCE_RESET_PERMISSIONS}" "${allow_defaults}")"
        if var_true "${force_val}" ; then
            print_debug "[configure_site/${_sitename}] [webroot] Force resetting recursively permissions of webroot to ${NGINX_USER}:${NGINX_GROUP}"
            chown -R "${NGINX_USER}":"${NGINX_GROUP}" "${webroot_val%/}"
        fi
    fi
    call phpfpm_nginx_create_location_block "${_sitename}"
}

nginx_site_configure_wellknown_mimetypes() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local allow_defaults="${2:-true}"
        local enable_var="NGINX_SITE_${_sitename^^}_ENABLE_WELLKNOWN_MIMETYPES"
        local enable_val
        enable_val="$(resolve_site_var "${enable_var}" "${NGINX_ENABLE_WELLKNOWN_MIMETYPES}" "${allow_defaults}")"
        if var_true "${enable_val,,}"; then
            print_notice "[configure_site/${_sitename}] [wellknown_mimetype] Enabled .wellknown mimetype"
            ln -sf /container/data/nginx/templates/site/location-mimetype-wellknown.template "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"/location-pre/10-mimetype-wellknown.conf
        fi
    fi
}

nginx_post_init() {
    :
}

nginx_run() {
    if [ "${NGINX_CONFIG_PATH%/}" != "/etc/nginx" ]; then
        local nginx_prefix="-p ${NGINX_CONFIG_PATH%/}"
        local config_deviated
    fi

    if [ "${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}" != "/etc/nginx/server.conf" ]; then
        local nginx_config="-c ${NGINX_CONFIG_PATH%/}/${NGINX_CONFIG_FILE}"
    fi
    print_start "Starting nginx $(nginx -V 2>&1 | head -n1 | cut -d / -f 2)"
    exec nginx ${nginx_prefix} ${nginx_config}
}

nginx_site_disable() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        if [ "${_sitename,,}" = "all" ] ; then
            find "${NGINX_CONFIG_PATH%/}"/sites.enabled -maxdepth 1 -type f -name '*.conf' ! -name '*.enc*' 2>/dev/null | while read -r site; do
                print_debug "Disabling Nginx Site '$(basename "${site}")'"
                rm -rf "${NGINX_CONFIG_PATH%/}/sites.enabled/$(basename "${site}")"*
            done
        else
            if [ -f "${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}.conf" ]; then
                print_debug "Disabling Nginx Site '${_sitename}.conf'"
                rm -rf "${NGINX_CONFIG_PATH%/}"/sites.enabled/"${_sitename}"*
                local site_dir="${NGINX_CONFIG_PATH%/}/sites.enabled/${_sitename}"
                if [ -d "${site_dir}" ]; then
                    rm -rf "${site_dir}" || true
                    print_debug "[site/disable] Removed site fragment directory ${site_dir}"
                fi
            else
                print_error "Cannot disable site '${_sitename}' as it doesn't exist in "${NGINX_CONFIG_PATH%/}"/sites.enabled!"
                exit 1
            fi
        fi
    else
        print_error "Need configuration file as argument to utilize 'nginx_site_disable' function"
    fi
}

nginx_site_enable() {
    if [ -n "${1}" ]; then
        local _sitename="${1}"
        local _site_total="${2:-}"
        if [ -f "/override/nginx/sites.available/${_sitename}.conf" ] ; then
            print_debug "[site_enable] Enabling override site '${_sitename}.conf'"
            ln -sf /override/nginx/sites.available/"${_sitename}".conf "${NGINX_CONFIG_PATH%/}"/sites.enabled
        else
            nginx_site_configure_bootstrap "${_sitename}" "${_site_total}"
            if [ -f "${NGINX_CONFIG_PATH%/}/sites.available/${_sitename}.conf" ]; then
                print_debug "[site_enable] Enabling site '${_sitename}.conf'"
                ln -sf "${NGINX_CONFIG_PATH%/}"/sites.available/"${_sitename}".conf "${NGINX_CONFIG_PATH%/}"/sites.enabled
            else
                print_error "Cannot enable site ${_sitename} as it doesn't exist!"
                exit 1
            fi

            local allow_defaults_var_site="NGINX_SITE_${_sitename^^}_ALLOW_DEFAULTS"
            local allow_defaults="${!allow_defaults_var_site}"
            if [ -z "${allow_defaults}" ]; then allow_defaults="${NGINX_ALLOW_DEFAULTS:-}"; fi
            if [ -z "${allow_defaults}" ]; then allow_defaults=true; fi
            for base_site_config in \
                                    listener \
                                    server_name \
                                    logging \
                                    headers \
                                ; do
                call nginx_site_configure_"${base_site_config}" "${_sitename}" "${allow_defaults,,}"
            done

            local site_mode_var="NGINX_SITE_${_sitename^^}_MODE"
            local _site_mode="${!site_mode_var}"
            if [ -z "${_site_mode}" ]; then
                if var_true "${allow_defaults}" && [ -n "${NGINX_MODE}" ]; then
                    _site_mode="${NGINX_MODE}"
                else
                    _site_mode="normal"
                fi
            fi

            case "${_site_mode,,}" in
                maintenance )
                    call nginx_site_configure_maintenance "${_sitename}" "${allow_defaults,,}"
                ;;
                proxy )
                    for proxy_site_config in \
                                                authentication \
                                                deny_hidden_files \
                                                disable_log_favicon \
                                                disable_log_robots \
                                            ; do
                        call nginx_site_configure_"${proxy_site_config}" "${_sitename}" "${allow_defaults,,}"
                    done
                    call nginx_site_configure_proxy "${_sitename}" "${allow_defaults,,}"
                ;;
                redirect )
                    call nginx_site_configure_redirect "${_sitename}" "${allow_defaults,,}"
                ;;
                normal | * )
                    for normal_site_config in \
                                                webroot_index \
                                                authentication \
                                                cache_client \
                                                deny_hidden_files \
                                                disable_log_favicon \
                                                disable_log_robots \
                                                enable_symlinks \
                                                exploit_protection \
                                                wellknown_mimetypes \
                                                fastcgi \
                                                scgi \
                                                uwsgi \
                                                includes \
                                                reset_permissions \
                                            ; do
                        call nginx_site_configure_"${normal_site_config}" "${_sitename}" "${allow_defaults,,}"
                    done
                ;;
            esac
        fi
    else
        print_error "[site_enable] Need configuration file as argument"
        exit 1
    fi
}

nginx_site_maintenance() {
    local action="${1,,}"
    local _sitename="${2}"
    local allow_defaults="${3:-true}"
    if [ -z "${action}" ] || [ -z "${_sitename}" ]; then
        print_error "[site_maintenance] Usage: nginx_site_maintenance <on|off|sleep> <sitename> [allow_defaults] [num] [unit]"
        return 1
    fi

    local sites_enabled_dir="${NGINX_CONFIG_PATH%/}/sites.enabled"
    local site_dir="${sites_enabled_dir}/${_sitename}"
    local backup_dir="${site_dir}.original"

    case "${action}" in
        on|true)
            if [ ! -d "${site_dir}" ]; then
                print_error "[site_maintenance/${_sitename}] Site folder not found: ${site_dir}"
                return 1
            fi
            if [ -d "${backup_dir}" ]; then
                print_error "[site_maintenance/${_sitename}] Backup folder already exists: ${backup_dir}"
                return 1
            fi
            mv "${site_dir}" "${backup_dir}"
            for fragment in server-pre server-begin location-pre location location-post server-end server-post; do
                create_folder "${site_dir}/${fragment}" "${NGINX_USER}:${NGINX_GROUP}" 755
            done
            if [ -d "${backup_dir}/server-pre" ]; then
                silent cp -a "${backup_dir}/server-pre/." "${site_dir}/server-pre/"
            fi
            if [ -d "${backup_dir}/server-begin" ]; then
                silent cp -a "${backup_dir}/server-begin/." "${site_dir}/server-begin/"
            fi
            call nginx_site_configure_maintenance "${_sitename}" "${allow_defaults}"
            nginx -s reload
            print_notice "[site_maintenance/${_sitename}] Site placed into maintenance mode"
        ;;
        off|false)
            if [ ! -d "${backup_dir}" ]; then
                print_error "[site_maintenance/${_sitename}] Backup folder not found: ${backup_dir}"
                return 1
            fi
            rm -rf "${site_dir}"
            mv "${backup_dir}" "${site_dir}"
            nginx -s reload
            print_notice "[site_maintenance/${_sitename}] Restored site from maintenance"
        ;;
        *)
            print_error "[site_maintenance/${_sitename}] Unknown action: ${action}. For temporary maintenance use the 'maintenance' CLI sleep option."
            return 1
        ;;
    esac
}

