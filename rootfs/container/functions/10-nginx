# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

nginx_configure_authentication_basic() {
    print_notice "Setting Basic Authentication"
    user_num=$(printenv | sort | grep -c 'NGINX_AUTHENTICATION_BASIC_USER.*')
    for ((num = 1; num <= user_num; num++)); do
        transform_var file \
                            NGINX_AUTHENTICATION_BASIC_USER${num} \
                            NGINX_AUTHENTICATION_BASIC_PASS${num}
        basic_user=NGINX_AUTHENTICATION_BASIC_USER${num}
        basic_pass=NGINX_AUTHENTICATION_BASIC_PASS${num}
        print_warn "Creating User: ${!basic_user}"
        htpasswd -b -n ${!basic_user:-$NGINX_AUTHENTICATION_BASIC_USER} ${!basic_pass:-$NGINX_AUTHENTICATION_BASIC_PASS} >> /etc/nginx/snippets/authentication/basic-authorized_users
    done
}

nginx_configure_authentication_ldap() {
    transform_var file \
                        NGINX_AUTHENTICATION_LDAP_HOST \
                        NGINX_AUTHENTICATION_LDAP_PORT \
                        NGINX_AUTHENTICATION_LDAP_BASE_DN \
                        NGINX_AUTHENTICATION_LDAP_BIND_DN \
                        NGINX_AUTHENTICATION_LDAP_BIND_PW
    cat <<EOF > /etc/nginx/snippets/authentication/ldap-configuration
ldap_server ldapserver {
        url "${NGINX_AUTHENTICATION_LDAP_HOST}/${NGINX_AUTHENTICATION_LDAP_BASE_DN}?${NGINX_AUTHENTICATION_LDAP_ATTRIBUTE}?${NGINX_AUTHENTICATION_LDAP_SCOPE}?${NGINX_AUTHENTICATION_LDAP_FILTER}";
        binddn "${NGINX_AUTHENTICATION_LDAP_BIND_DN}";
        binddn_passwd ${NGINX_AUTHENTICATION_LDAP_BIND_PW};
        group_attribute ${NGINX_AUTHENTICATION_LDAP_GROUP_ATTRIBUTE};
        group_attribute_is_dn on;
        require valid_user;
        satisfy all;
    }
EOF
    ln -sf /etc/nginx/snippets/authentication/ldap-configuration /etc/nginx/snippets/server.enabled/
}

nginx_configure_authentication_llng() {
    print_notice "Setting LLNG Authentication"
    if var_true "${NGINX_ENABLE_UPSTREAM_KEEPALIVE}" ; then
        upstream_keepalive="keepalive ${NGINX_UPSTREAM_KEEPALIVE};"
    fi
    transform_var file \
                    NGINX_AUTHENTICATION_LLNG_HANDLER_HOST \
                    NGINX_AUTHENTICATION_LLNG_HANDLER_PORT
    llng_upstream_hosts=$(echo "${NGINX_AUTHENTICATION_LLNG_HANDLER_HOST}" | tr "," "\n")
    echo "upstream llng-upstream-pool {" >> /etc/nginx/snippets/authentication/llng-upstream
    echo "     ${upstream_keepalive}" >> /etc/nginx/snippets/authentication/llng-upstream
    for host in ${llng_upstream_hosts}; do
        if [[ ${host} != *":"* ]]; then
            llng_handler_listen_port=":${NGINX_AUTHENTICATION_LLNG_HANDLER_PORT}"
        else
            llng_handler_listen_port=""
        fi
        echo "    server $host${llng_handler_listen_port} ${NGINX_UPSTREAM_OPTIONS};" >> /etc/nginx/snippets/authentication/llng-upstream
    done
    echo "}" >> /etc/nginx/snippets/authentication/llng_upstream
    sed -i -e "/# Do not delete - Upstream Configuration/a\ \ \ \ include \/etc\/nginx\/snippets\/authentication\/llng_upstream;" /etc/nginx/nginx.conf
    sed -i -e "/# Do not delete - Upstream Configuration/a\ \ \ \ ### LLNG Authentication Multiple Handlers configuration" /etc/nginx/nginx.conf
    update_template /etc/nginx/snippets/authentication/llng-location_block \
                                                                            NGINX_AUTHENTICATION_LLNG_HANDLER_PORT \
                                                                            NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFER_SIZE \
                                                                            NGINX_AUTHENTICATION_LLNG_FASTCGI_BUFFERS

    if [ ! -f "/container/init/init.d/20-php-fpm" ]; then
        header_num=$(printenv | sort | grep -c '^NGINX_AUTHENTICATION_LLNG_ATTRIBUTE.*')
        for ((llngheader = 1; llngheader <= header_num; llngheader++)); do
            headers=NGINX_AUTHENTICATION_LLNG_ATTRIBUTE${llngheader}
            IFS=',' read -r -a array <<<"${!headers}"
            print_notice "Updating Nginx to support recieving attribute from LLNG: '${array[0]}'"
            echo "fastcgi_param ${array[0]} \$${array[1]};" >> /etc/nginx/snippets/authentication/llng-params
            echo "auth_request_set \$${array[1]} \$${array[2]};" >> /etc/nginx/snippets/authentication/llng-auth_request
        done
    else
        print_debug "Skipping LLNG Authentication configuration until configured by PHP-FPM"
    fi
}

nginx_configure_headers() {
    if var_true "${NGINX_ENABLE_HEADERS}"; then
        print_debug "Configuring Custom Headers"
        if [ ! -f "${NGINX_HEADER_FILE}" ] ; then touch "${NGINX_HEADER_FILE}"; fi

        hnum=$(printenv | sort | grep -cE '^NGINX_HEADER_[0-9]{2}_NAME')
        for ((i = 1; i <= hnum; i++)); do
            num=$(printf "%02d" ${i})
            transform_var file \
                            NGINX_HEADER_${num}_NAME \
                            NGINX_HEADER_${num}_VALUE \
                            NGINX_HEADER_${num}_FLAG

            nv="NGINX_HEADER_${num}_NAME"
            vv="NGINX_HEADER_${num}_VALUE"
            fv="NGINX_HEADER_${num}_FLAG"
            hn="${!nv}"
            hv="${!vv}"
            hf="${!fv}"

            if [ -z "${hn}" ] || [ -z "${hv}" ]; then
                print_debug "[headers] Skipping unset header ${num} (${nv} or ${vv} missing)"
                continue
            fi

            case "${hn,,}" in
                none | false | unset | null )
                    print_debug "[headers] Skipping header ${num} as name is set to 'none'"
                    continue
                ;;
            esac

            hve="$(echo "${hv}" | sed 's/"/\\"/g')"
            printf 'add_header %s "%s"%s;\n' "${hn}" "${hve}" "${hf:+ ${hf}}" | silent tee -a "${hconf}"
            print_debug "[headers] Added header '${hn}'"
        done
    fi
}

nginx_configure_logging() {
    update_template /etc/nginx/snippets/server.available/logging.conf \
                                                                    NGINX_LOG_ACCESS_FILE \
                                                                    NGINX_LOG_ACCESS_LOCATION \
                                                                    NGINX_LOG_ACCESS_FORMAT \
                                                                    NGINX_LOG_ERROR_FILE \
                                                                    NGINX_LOG_LEVEL_ERROR \
                                                                    NGINX_LOG_ERROR_LOCATION

    mkdir -p "${NGINX_LOG_ERROR_LOCATION}" "${NGINX_LOG_ACCESS_LOCATION}"
    touch "${NGINX_LOG_ERROR_LOCATION}"/"${NGINX_LOG_ERROR_FILE}"
    touch "${NGINX_LOG_ACCESS_LOCATION}"/"${NGINX_LOG_ACCESS_FILE}"
    chown -R "${NGINX_USER}" "${NGINX_LOG_ERROR_LOCATION}" "${NGINX_LOG_ACCESS_LOCATION}"

    create_logrotate nginx-access "${NGINX_LOG_ACCESS_LOCATION}"/"${NGINX_LOG_ACCESS_FILE}" nginx-"${NGINX_LOG_ACCESS_FORMAT}" "${NGINX_USER}" "${NGINX_GROUP}"
    create_logrotate nginx-error "${NGINX_LOG_ACCESS_LOCATION}"/"${NGINX_LOG_ERROR_FILE}" nginx-error-standard,nginx-error-alt-standard "${NGINX_USER}" "${NGINX_GROUP}"

    if var_true "${NGINX_ENABLE_EXPLOIT_PROTECTION}" ; then
        mkdir -p "${NGINX_LOG_BLOCKED_LOCATION}"
        touch "${NGINX_LOG_BLOCKED_LOCATION}"/"${NGINX_LOG_BLOCKED_FILE}"
        update_template /etc/nginx/snippets/exploit_protection.conf \
                                                                    NGINX_LOG_BLOCKED_LOCATION \
                                                                    NGINX_LOG_BLOCKED_FILE \
                                                                    NGINX_LOG_BLOCKED_FORMAT
        create_logrotate nginx-blocked "${NGINX_LOG_BLOCKED_LOCATION}"/"${NGINX_LOG_BLOCKED_FILE}" nginx-blocked-"${NGINX_LOG_BLOCKED_FORMAT}" "${NGINX_USER}" "${NGINX_GROUP}"
    fi

    if [ -f "${NGINX_ACCESS_LOG_LOCATION}/*-access.log" ] ; then
        set -f
        create_logrotate nginx-wildcard "${NGINX_LOG_ACCESS_LOCATION}"/*-access.log nginx-"${NGINX_LOG_ACCESS_FORMAT}" "${NGINX_USER}" "${NGINX_GROUP}"
        set +f
    fi

    if [ -f "${NGINX_ERROR_LOG_LOCATION}/*-error.log" ] ; then
        set -f
        create_logrotate nginx-error-wildcard "${NGINX_LOG_ERROR_LOCATION}"/*-error.log nginx-error-standard,nginx-error-alt-standard "${NGINX_USER}" "${NGINX_GROUP}"
        set +f
    fi

    nginx_snippet server true logging.conf
}

nginx_configure_maintenance() {
        update_template "/etc/nginx/templates/*.template" NGINX_LISTEN_PORT

        case "${NGINX_MAINTENANCE_TYPE,,}" in
            local )
                update_template /etc/nginx/templates/maintenance.template \
                                                                            NGINX_MAINTENANCE_FILE \
                                                                            NGINX_MAINTENANCE_PATH
                if [ -n "${NGINX_MAINTENANCE_REMOTE_URL}" ] ; then
                    print_notice "Adding custom maintenance page from '${NGINX_MAINTENANCE_REMOTE_URL}'"
                    silent curl -sSL -o "${NGINX_MAINTENANCE_PATH%/}"/"${NGINX_MAINTENANCE_FILE}" "${NGINX_MAINTENANCE_REMOTE_URL}"
                fi
            ;;
            proxy )
                if [ -n "${NGINX_MAINTENANCE_PROXY_URL}" ] ; then
                    cat <<EOF > /etc/nginx/templates/maintenance.template
server {
    listen ${NGINX_LISTEN_PORT};
    server_name localhost;

    location / {
        proxy_pass              ${NGINX_MAINTENANCE_PROXY_URL};
        proxy_redirect          off;
        proxy_set_header        X-Real-IP \$remote_addr;
        proxy_set_header        X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Host \$server_name;
        proxy_ssl_server_name   on;
    }

### Don't edit past here
}
EOF

                else
                    sanity_var NGINX_MAINTENANCE_PROXY_URL "Set NGINX_MAINTENANCE_TYPE=proxy"
                fi
            ;;
            redirect )
                if [ -n "${NGINX_MAINTENANCE_REDIRECT_URL}" ] ; then
                    print_notice "Setting maintenance redirect to '${NGINX_MAINTENANCE_REDIRECT_URL}'"
                    cat <<EOF > /etc/nginx/templates/maintenance.template
  server {
    listen       ${NGINX_LISTEN_PORT};
    server_name  localhost;

	rewrite ^/(.*) ${NGINX_MAINTENANCE_REDIRECT_URL};

}
EOF
                else
                    sanity_var NGINX_MAINTENANCE_REDIRECT_URL "Set NGINX_MAINTENANCE_TYPE=redirect"
                fi
            ;;

        esac
        chown -R "${NGINX_USER}":"${NGINX_GROUP}" "${NGINX_MAINTENANCE_PATH}"
}

nginx_configure_mode() {
    case "${NGINX_MODE,,}" in
        "maintenance" )
            print_warn "MAINTENANCE MODE ACTIVATED - THIS IMAGE WILL NOT SERVE PAGES"
            sed -i "s|include /etc/nginx/sites.enabled/\*.conf;|#include /etc/nginx/sites.enabled/*.conf;|g" /etc/nginx/nginx.conf
            sed -i "/include \/etc\/nginx\/templates\/proxy.template;/d" /etc/nginx/nginx.conf
            sed -i "/include \/etc\/nginx\/templates\/redirect.template;/d" /etc/nginx/nginx.conf
        ;;
        "proxy" )
            sanity_var NGINX_PROXY_URL "No Proxy URL"
            NGINX_ENABLE_CREATE_SAMPLE_HTML=FALSE
            print_notice "Proxy Mode Activated - Proxying all traffic to ${NGINX_PROXY_URL}"
            update_template /etc/nginx/templates/proxy.template NGINX_PROXY_URL
            sed -i "/include \/etc\/nginx\/sites.enabled\/\*.conf;/d" /etc/nginx/nginx.conf
            sed -i "s|include /etc/nginx/templates/maintenance.template;|#include /etc/nginx/templates/maintenance.template;|g" /etc/nginx/nginx.conf
            sed -i "/include \/etc\/nginx\/templates\/redirect.template;/d" /etc/nginx/nginx.conf
            case "${NGINX_AUTHENTICATION_TYPE,,}" in
                "basic" )
                    sed -i '/server {/a\ \ \ \ \ auth_basic "'"${NGINX_AUTHENTICATION_TITLE}"'";\n\ \ \ \ \ auth_basic_user_file /etc/nginx/snippets/authentication/basic_authorized_users;' /etc/nginx/templates/proxy.template
                ;;
                "ldap" )
                    sed -i '/server {/a\ \ \ \ \ auth_ldap "'"${NGINX_AUTHENTICATION_TITLE}"'";\n\ \ \ \ \ auth_ldap_servers ldapserver;' /etc/nginx/templates/proxy.template
                ;;
                "llng" )
                    sed -i '/server {/a\ \ \ \ \  include /etc/nginx/snippets/authentication/llng_location_block;' /etc/nginx/templates/proxy.template
                    sed -i '/server {/a\ \ \ \ \  ### LLNG Authentication Checkpoint' /etc/nginx/templates/proxy.template
                    sed -i '/location \/ {/a\ \ \ \ \ \ \ \ include /etc/nginx/snippets/authentication/llng_auth_request;' /etc/nginx/templates/proxy.template
                    sed -i '/location \/ {/a\ \ \ \ \ \ \ \ ### LLNG Authentication handler' /etc/nginx/templates/proxy.template
                ;;
            esac
        ;;
        "redirect" )
            sanity_var NGINX_REDIRECT_URL "No Redirect URL"
            NGINX_ENABLE_CREATE_SAMPLE_HTML=FALSE
            print_notice "Redirect Mode Activated - Redirecting all traffic to ${NGINX_REDIRECT_URL}"
            update_template /etc/nginx/templates/redirect.template NGINX_REDIRECT_URL
            sed -i "/include \/etc\/nginx\/sites.enabled\/\*.conf;/d" /etc/nginx/nginx.conf
            sed -i "s|include /etc/nginx/templates/maintenance.template;|#include /etc/nginx/templates/maintenance.template;|g" /etc/nginx/nginx.conf
            sed -i "/include \/etc\/nginx\/templates\/proxy.template;/d" /etc/nginx/nginx.conf
        ;;
        "normal" | * )
            sed -i "s|include /etc/nginx/templates/maintenance.template;|#include /etc/nginx/templates/maintenance.template;|g" /etc/nginx/nginx.conf
            sed -i "/include \/etc\/nginx\/templates\/proxy.template;/d" /etc/nginx/nginx.conf
            sed -i "/include \/etc\/nginx\/templates\/redirect.template;/d" /etc/nginx/nginx.conf
        ;;
    esac
}

nginx_configure_server() {
    truefalse_onoff NGINX_ENABLE_MULTI_ACCEPT lowercase
    truefalse_onoff NGINX_ENABLE_RESET_TIMEDOUT_CONNECTION lowercase
    truefalse_onoff NGINX_ENABLE_SENDFILE lowercase
    truefalse_onoff NGINX_ENABLE_TCPNODELAY lowercase
    truefalse_onoff NGINX_ENABLE_TCPNOPUSH lowercase

    update_template /etc/nginx/nginx.conf \
                                            NGINX_CLIENT_BODY_BUFFER_SIZE \
                                            NGINX_CLIENT_BODY_TIMEOUT \
                                            NGINX_CONNECTION_PROCESSING_METHOD \
                                            NGINX_ENABLE_MULTI_ACCEPT \
                                            NGINX_ENABLE_RESET_TIMEDOUT_CONNECTION \
                                            NGINX_ENABLE_SENDFILE \
                                            NGINX_ENABLE_TCPNODELAY \
                                            NGINX_ENABLE_TCPNOPUSH \
                                            NGINX_FASTCGI_BUFFERS \
                                            NGINX_FASTCGI_BUFFER_SIZE \
                                            NGINX_GROUP \
                                            NGINX_KEEPALIVE_REQUESTS \
                                            NGINX_KEEPALIVE_TIMEOUT \
                                            NGINX_PROXY_BUFFERS \
                                            NGINX_PROXY_BUFFER_SIZE \
                                            NGINX_PROXY_BUSY_BUFFERS_SIZE \
                                            NGINX_SEND_TIMEOUT \
                                            NGINX_SERVER_NAMES_HASH_BUCKET_SIZE \
                                            NGINX_UPLOAD_MAX_SIZE \
                                            NGINX_USER \
                                            NGINX_WORKER_CONNECTIONS \
                                            NGINX_WORKER_PROCESSES \
                                            NGINX_WORKER_RLIMIT_NOFILE

    call nginx_configure_server_compression_brotli
    call nginx_configure_server_compression_gzip
    call nginx_configure_server_ddos_protection
    call nginx_configure_server_cache_open_file
    call nginx_configure_server_reverse_proxy
    call nginx_configure_server_metrics
    call nginx_configure_server_resolver
    call nginx_configure_server_fastcgi
    call nginx_configure_server_proxy_buffering
    call nginx_configure_server_tokens
}

nginx_configure_server_authentication() {
    ### Map Authentication
    case "${NGINX_AUTHENTICATION_TYPE,,}" in
        "none")
            :
        ;;
        *)
            call nginx_configure_authentication_${NGINX_AUTHENICATION_TYPE,,}
        ;;
    esac
}

nginx_configure_server_blockbots() {
    if var_true "${NGINX_ENABLE_BLOCK_BOTS}" ; then
        sed -i "/server_names_hash_bucket_size/d" /etc/nginx/nginx.conf
        sed -i "\|### Don't edit past here|a\ \ \ \ \  include /etc/nginx/snippets/blockbots/ddos.conf;" /etc/nginx/sites.available/*.conf
        if [ ! -f "/etc/nginx/snippets/blockbots-custom/bad-referrer-words.conf" ]; then
            cp -R /etc/nginx/snippets/blockbots/bad-referrer-words.conf /etc/nginx/snippets/blockbots-custom/
        fi
        if [ ! -f "/etc/nginx/snippets/blockbots-custom/blacklist-ips.conf" ]; then
            cp -R /etc/nginx/snippets/blockbots/blacklist-ips.conf /etc/nginx/snippets/blockbots-custom/
        fi
        if [ ! -f "/etc/nginx/snippets/blockbots-custom/blacklist-user-agents.conf" ]; then
            cp -R /etc/nginx/snippets/blockbots/blacklist-user-agents.conf /etc/nginx/snippets/blockbots-custom/
        fi
        if [ ! -f "/etc/nginx/snippets/blockbots-custom/custom-bad-referrers.conf" ]; then
            cp -R /etc/nginx/snippets/blockbots/custom-bad-referrers.conf /etc/nginx/snippets/blockbots-custom/
        fi
        if [ ! -f "/etc/nginx/snippets/blockbots-custom/whitelist-ips.conf" ]; then
            cp -R /etc/nginx/snippets/blockbots/whitelist-ips.conf /etc/nginx/snippets/blockbots-custom/
        fi
        if [ ! -f "/etc/nginx/snippets/blockbots-custom/whitelist-domains.conf" ]; then
            cp -R /etc/nginx/snippets/blockbots/whitelist-domains.conf /etc/nginx/snippets/blockbots-custom/
        fi
        if [ -d "/container/data/nginx/blockbots-custom" ] ; then
            print_notice "Detected Custom Bot Blocking configuration"
            cp -R /container/data/nginx/blockbots-custom/* /etc/nginx/snippets/blockbots-custom/
        fi

        if [ -n "${NGINX_BLOCK_BOTS_WHITELIST_DOMAIN}" ]; then
            whitelist_domains=$(echo "${NGINX_BLOCK_BOTS_WHITELIST_DOMAIN,,}" | tr "," "\n")
            for wl_domain in $whitelist_domains; do
                wl_domain_orig=${wl_domain}
                wl_domain="$(echo "$wl_domain" | sed "s|\\.|\\\.|g" | sed "s|-|\\\-|g")"
                if ! grep -q "${wl_domain_orig}" /etc/nginx/snippets/blockbots-custom/whitelist-domains.conf ; then
                    print_debug  "Adding '${wl_domain_orig}' domain to bot blocker whitelist"
                    echo '"~*(?:\b)'$(echo "$wl_domain")'(?:\b)" 0;' $(echo " # ${wl_domain_orig} automatically added on") $(date +"%Y-%m-%d-%H:%M:%S") >> /etc/nginx/snippets/blockbots-custom/whitelist-domains.conf
                elsebolster-zipping-tartly-swimsuit
                    print_debug "Skipping '${wl_domain_orig}' to be added to bot blocker domain whitelist"
                fi
            done
        fi

        if [ -n "${NGINX_BLOCK_BOTS_WHITELIST_IP}" ]; then
            whitelist_ips=$(echo "${NGINX_BLOCK_BOTS_WHITELIST_IP}" | tr "," "\n")
            for wl_ip in $whitelist_ips; do
                if ! grep -q "${wl_ip}" /etc/nginx/snippets/blockbots-custom/whitelist-ips.conf ; then
                    print_debug  "Adding IP: '${wl_ip}' to bot blocker whitelist"
                    echo "${wl_ip} 0; # Automatically added on $(date +"%Y-%m-%d-%H:%M:%S")" >> /etc/nginx/snippets/blockbots-custom/whitelist-ips.conf
                else
                    print_debug "Skipping IP: '${wl_ip}' from being added to bot blocker IP whitelist"
                fi
            done
        fi

        if [ -n "${NGINX_BLOCK_BOTS}" ] ; then
            if [[ "${NGINX_BLOCK_BOTS,}" == *"all" ]] ; then
                NGINX_BLOCK_BOTS=ALL
            fi

            IFS=","
            for bot in $NGINX_BLOCK_BOTS ; do
                case "${bot,,}" in
                    "all" )
                        nginx_block_bots="adidxbot,aolbuild,bingbot,bingpreview,DoCoMo,duckduckgo,facebookexternalhit,facebookplatform,AdsBot-Google,Googlebot,Googlebot-Image,Googlebot-Mobile,Googlebot-News,Googlebot/Test,Googlebot-Video,Google-HTTP-Java-Client,LinkedInBot,Gravityscan,Jakarta\\ Commons,Kraken/0.1,teoma,msnbot,msnbot-media,SAMSUNG,Slackbot,Slackbot-LinkExpanding,slurp,TwitterBot,Wordpress,yahoo"
                    ;;
                    "aol" )
                        nginx_block_bots="aolbuild,${nginx_block_bots}"
                    ;;
                    "bing" )
                        nginx_block_bots="bingbot,bingpreview,${nginx_block_bots}"
                    ;;
                    "docomo" )
                        nginx_block_bots="DoCoMo,${nginx_block_bots}"
                    ;;
                    "duckduckgo" )
                        nginx_block_bots="duckduckgo,${nginx_block_bots}"
                    ;;
                    "facebook" )
                        nginx_block_bots="developers.facebook.com,facebookexternalhit,facebookplatform,${nginx_block_bots}"
                    ;;
                    "google" )
                        nginx_block_bots="AdsBot-Google,Googlebot,Googlebot-Image,Googlebot-Mobile,Googlebot-News,Googlebot/Test,Googlebot-Video,Google-HTTP-Java-Client,${nginx_block_bots}"
                    ;;
                    "linkedin" )
                        nginx_block_bots="LinkedInBot,${nginx_block_bots}"
                    ;;
                    "misc" )
                        nginx_block_bots="adidxbot,Gravityscan,'Jakarta\ Commons',Kraken/0.1,teoma,${nginx_block_bots}"
                    ;;
                    "msn" )
                        nginx_block_bots="msnbot,msnbot-media,${nginx_block_bots}"
                    ;;
                    "samsung" )
                        nginx_block_bots="SAMSUNG,${nginx_block_bots}"
                    ;;
                    "slack" )
                        nginx_block_bots="Slackbot,Slackbot-LinkExpanding,${nginx_block_bots}"
                    ;;
                    "slurp" )
                        nginx_block_bots="slurp,${nginx_block_bots}"
                    ;;
                    "twitter" )
                        nginx_block_bots="TwitterBot,${nginx_block_bots}"
                    ;;
                    "wordpress" )
                        nginx_block_bots="Wordpress,${nginx_block_bots}"
                    ;;
                    "yahoo" )
                        nginx_block_bots="yahoo,${nginx_block_bots}"
                    ;;
                    * )
                        nginx_block_bots="${bot},${nginx_block_bots}"
                    ;;
                esac
            done

            NGINX_BLOCK_BOTS_BLACKLIST_USER_AGENTS="${nginx_block_bots}"
        fi

        if [ -n "${NGINX_BLOCK_BOTS_BLACKLIST_USER_AGENTS}" ]; then
            IFS=","
            for blacklist_ua in $NGINX_BLOCK_BOTS_BLACKLIST_USER_AGENTS; do
                blacklist_ua_orig="$(echo "$blacklist_ua" | sed "s|\\\||g")"
                if ! grep -q "${blacklist_ua_orig}" /etc/nginx/snippets/blockbots-custom/blacklist-user-agents.conf ; then
                    print_debug  "[botblock] Adding UA: '${blacklist_ua_orig}' to bot blocker blacklist"
                    echo '"~*(?:\b)'$(echo "$blacklist_ua")'(?:\b)" 3; # '${blacklist_ua_orig}' Automatically added on '$(date +"%Y-%m-%d-%H:%M:%S") >> /etc/nginx/snippets/blockbots-custom/blacklist-user-agents.conf
                else
                    print_debug "Skipping UA: '${blacklist_ua_orig}' from being added to bot blocker blacklist"
                fi
            done
        fi

        nginx_snippet server ${NGINX_ENABLE_BLOCK_BOTS} deny-botblocker.conf
    fi
}

nginx_configure_server_cache_open_file() {
    truefalse_onoff NGINX_CACHE_OPEN_FILE_ERRORS lowercase
    update_template /etc/nginx/snippets/server.available/cache-open_file.conf \
                                                                NGINX_CACHE_OPEN_FILE_ERRORS \
                                                                NGINX_CACHE_OPEN_FILE_INACTIVE \
                                                                NGINX_CACHE_OPEN_FILE_MAX \
                                                                NGINX_CACHE_OPEN_FILE_MIN_USES \
                                                                NGINX_CACHE_OPEN_FILE_VALID

    nginx_snippet server ${NGINX_ENABLE_CACHE_OPEN_FILE} cache-open_file.conf
}

nginx_configure_server_compression_brotli() {
    update_template /etc/nginx/snippets/server.available/compression-brotli.conf \
                                                                    NGINX_COMPRESSION_BROTLI_LEVEL \
                                                                    NGINX_COMPRESSION_BROTLI_MIN_LENGTH \
                                                                    NGINX_COMPRESSION_BROTLI_TYPES \
                                                                    NGINX_COMPRESSION_BROTLI_WINDOW

    nginx_snippet server ${NGINX_ENABLE_COMPRESSION_BROTLI} compression-brotli.conf
}

nginx_configure_server_compression_gzip() {
    truefalse_onoff NGINX_COMPRESSION_GZIP_VARY lowercase
    update_template /etc/nginx/snippets/server.available/compression-gzip.conf \
                                                                NGINX_COMPRESSION_GZIP_BUFFERS \
                                                                NGINX_COMPRESSION_GZIP_DISABLE \
                                                                NGINX_COMPRESSION_GZIP_HTTP_VERSION \
                                                                NGINX_COMPRESSION_GZIP_LEVEL \
                                                                NGINX_COMPRESSION_GZIP_MIN_LENGTH \
                                                                NGINX_COMPRESSION_GZIP_PROXIED \
                                                                NGINX_COMPRESSION_GZIP_TYPES \
                                                                NGINX_COMPRESSION_GZIP_VARY

    nginx_snippet server ${NGINX_ENABLE_COMPRESSION_GZIP} compression-gzip.conf
}

nginx_configure_server_ddos_protection() {
    update_template /etc/nginx/snippets/server.available/limit-ddos_protection.conf \
                                                                NGINX_DDOS_CONNECTIONS_PER_IP \
                                                                NGINX_DDOS_REQUESTS_PER_IP

    nginx_snippet server ${NGINX_ENABLE_DDOS_PROTECTION} limit-ddos_protection.conf
}

nginx_configure_server_fastcgi() {
    truefalse_onoff NGINX_ENABLE_FASTCGI_HTTPS lowercase
    sed -i "s|fastcgi_param .* HTTPS .*;|fastcgi_param  HTTPS ${NGINX_ENABLE_FASTCGI_HTTPS};|g" /etc/nginx/fastcgi_params

    fastcginum=$(printenv | sort | grep -cE '^FASTCGI([0-9].)_PARAM')
    for (( fastcgiparam = 01; fastcgiparam <= fastcginum; fastcgiparam++ )) ; do
        fastcgiparam=$(printf "%02d" $fastcgiparam)
        fastcgiparam_value=$(set -o posix ; set | grep ^FASTCGI${fastcgi_param}_PARAM= | cut -d = -f 2-)
        echo "fastcgi_param     $(echo "${fastcgiparam_value}" | cut -d , -f1})  $(echo "${fastcgiparam_value}" | cut -d , -f2-})";
    done
}

nginx_configure_server_metrics() {
    NGINX_VERSION="$(nginx -V 2>&1 | head -n1 | cut -d / -f 2)"
    update_template /etc/nginx/snippets/metrics.conf \
                                                        NGINX_VERSION

    nginx_snippet server ${NGINX_ENABLE_METRICS} metrics.conf
}

nginx_configure_server_proxy_buffering() {
    truefalse_onoff NGINX_ENABLE_PROXY_BUFFERING lowercase
    update_template /etc/nginx/snippets/server.available/proxy-buffer.conf \
                                                                            NGINX_ENABLE_PROXY_BUFFERING \
                                                                            NGINX_PROXY_BUFFERS \
                                                                            NGINX_PROXY_BUFFER_SIZE \
                                                                            NGINX_PROXY_BUSY_BUFFERS_SIZE

    ln -sf /etc/nginx/snippets/server.available/proxy-buffer.conf /etc/nginx/snippets/server.enabled/
}

nginx_configure_server_resolver() {
    if [ -n "${NGINX_RESOLVER}" ]; then
        update_template /etc/nginx/snippets/server.available/resolver.conf \
                                                                                NGINX_RESOLVER

        ln -sf /etc/nginx/snippets/server.available/resolver.conf /etc/nginx/snippets/server.enabled/
    fi
}

nginx_configure_server_reverse_proxy() {
    update_template /etc/nginx/snippets/server.available/headers-proxy.conf \
                                                                NGINX_REAL_IP_HEADER \
                                                                NGINX_SET_REAL_IP_FROM

    nginx_snippet server ${NGINX_ENABLE_REVERSE_PROXY} headers-proxy.conf
}

nginx_configure_server_tokens() {
    if var_false "${NGINX_ENABLE_SERVER_TOKENS}"; then
        ln -sf /etc/nginx/snippets/server.available/headers-server.conf /etc/nginx/snippets/server.enabled/
    fi

    truefalse_onoff NGINX_ENABLE_SERVER_TOKENS lowercase
    update_template /etc/nginx/snippets/server.available/tokens.conf \
                                                                        NGINX_ENABLE_SERVER_TOKENS

    ln -sf /etc/nginx/snippets/server.available/tokens.conf /etc/nginx/snippets/server.enabled/
}

nginx_configure_site_authentication() {
    local authentication_basic_include="sed -i \"/server {/a\ \ \ \ auth_basic '${NGINX_AUTHENTICATION_TITLE}';\n\ \ \ \ auth_basic_user_file /etc/nginx/snippets/authentication/basic-authorized_users;\" ${1}"
    local authentication_ldap_include="sed -i \"/server {/a\ \ \ \ auth_ldap '${NGINX_AUTHENTICATION_TITLE}';\n\ \ \ \ auth_ldap_servers ldapserver;\" ${1}"
    local authentication_llng_include="sed -i -e \"/server {/a\ \ \ include /etc/nginx/snippets/authentication/llng-location_block;\" -e \"/server {/a\ \ \  ### LLNG Authentication Checkpoint\" -e \"/location \/ {/a\ \ \ \ \ \ \ \ include /etc/nginx/snippets/authentication/llng-auth_request;\" -e \"/location \/ {/a\ \ \ \ \ \ \ \ ### LLNG Authentication handler\" ${1}"
    case "${NGINX_AUTHENTICATION_TYPE,,}" in
        "basic" )
            print_info "[configure_site] [${site}] Enabled Basic Authentication"
            print_warn "[configure_site] [${site}] [authentication] Using legacy variable / value - Convert to 'NGINX_${site^^}_AUTHENTICATION_TYPE'"
            eval "${authentication_basic_include}"
        ;;
        "ldap" )
            print_info "[configure_site] [${site}] Enabled LDAP Authentication"
            print_warn "[configure_site] [${site}] [authentication] Using legacy variable / value - Convert to 'NGINX_${site^^}_AUTHENTICATION_TYPE'"
            eval "${authentication_ldap_include}"
        ;;
        "llng" )
            print_info "[configure_site] [${site}] Enabled LLNG Authentication"
            print_warn "[configure_site] [${site}] [authentication] Using legacy variable / value - Convert to 'NGINX_${site^^}_AUTHENTICATION_TYPE'"
            eval "${authentication_llng_include}"
        ;;
    esac

    if [ -v NGINX_${site^^}_AUTHENTICATION_TYPE ] ; then
        local authentication_value="$(set -o posix ; set | grep "NGINX_${site^^}_AUTHENTICATION_TYPE=" | cut -d = -f 2)"
        case "${authentication_value,,}" in
            "basic" )
                print_info "[configure_site] [${site}] Enabled Basic Authentication"
                print_warn "[configure_site] [${site}] [authentication] Using legacy variable / value - Convert to 'NGINX_${site^^}_AUTHENTICATION_TYPE'"
                eval "${authentication_basic_include}"
            ;;
            "ldap" )
                print_info "[configure_site] [${site}] Enabled LDAP Authentication"
                print_warn "[configure_site] [${site}] [authentication] Using legacy variable / value - Convert to 'NGINX_${site^^}_AUTHENTICATION_TYPE'"
                eval "${authentication_ldap_include}"
            ;;
            "llng" )
                print_info "[configure_site] [${site}] Enabled LLNG Authentication"
                print_warn "[configure_site] [${site}] [authentication] Using legacy variable / value - Convert to 'NGINX_${site^^}_AUTHENTICATION_TYPE'"
                eval "${authentication_llng_include}"
            ;;
        esac
        unset blockbots_value
    fi
}

nginx_configure_site_blockbots() {
    local blockbots_link="ln -sf /etc/nginx/snippets/sites.available/blockbots.conf /etc/nginx/snippets/sites.enabled/${1}"
    local blockbots_remove="rm -rf /etc/nginx/snippets/sites.enabled/${1}/blockbots.conf/${1}/blockbots.conf"
    case "${NGINX_ENABLE_BLOCKBOTS,,}" in
        true )
            print_info "[configure_site] [${site}] Enabled Bot Blocking"
            print_warn "[configure_site] [${site}] [bot_blocking] Using legacy 'TRUE' value - Convert to 'NGINX_${site^^}_ENABLE_BLOCKBOTS'"
            eval "${blockbots_link}"
        ;;
        all )
            print_info "[configure_site] [${site}] Enabled Bot Blocking"
            print_debug "[configure_site] [${site}] [bot_blocking] Using 'all' value"
            eval "${blockbots_link}"
        ;;
        "${1}" )
            print_info "[configure_site] [${site}] Enabled Exploit protection"
            print_debug "[configure_site] [${site}] [bot_blocking] Using 'site' value"
            eval "${blockbots_link}"
        ;;
        none | false )
            eval "${blockbots_remove}"
        ;;
    esac

    if [ -v NGINX_${site^^}_ENABLE_BLOCKBOTS ] ; then
        local blockbots_value="$(set -o posix ; set | grep "NGINX_${site^^}_ENABLE_BLOCKBOTS=" | cut -d = -f 2)"
        case "${blockbots_value,,}" in
            true | all | ${1} )
                print_info "[configure_site] [${site}] Enabled Exploit protection"
                eval "${blockbots_link}"
            ;;
            none | false )
                eval "${blockbots_remove}"
            ;;
        esac
        unset blockbots_value
    fi

    unset blockbots_link
    unset blockbots_remove
}


nginx_configure_site_bootstrap() {
    for site_varlist in $(grep -oP "(?<=\{\{).*?(?=\}\})" "${1}"); do
        if [ -n "${!site_varlist}" ]; then
            update_template "${1}" "${site_varlist}"
        else
            print_debug "[nginx_configure_site_bootstrap] Skipping unset variable: ${site_varlist}"
        fi
    done

    mkdir -p /etc/nginx/snippets/sites.enabled/"$(basename "${1%.*}")"
}

nginx_configure_site_headers() {
    update_template "${1}" \
                            NGINX_SITE_HEADERS
}

nginx_configure_site_cache_client() {
    create_cache_config() {
        if [ -v NGINX_${1}_ENABLE_CLIENT_CACHE ]; then
            client_cache_site_value="$(set -o posix ; set | grep "NGINX_${1}_ENABLE_CLIENT_CACHE" | cut -d = -f 2 | tr ',' '\n')"
            client_cache_prefix="NGINX_${1}_CLIENT_CACHE"
            if [ "${client_cache_site_value,,}" = "unset" ]; then
                return 0
            fi
        else
            client_cache_site_value="$(echo "${NGINX_CLIENT_CACHE,,}" | tr ',' '\n')"
            client_cache_prefix="NGINX_CLIENT_CACHE"
        fi

        for ccc in ${client_cache_site_value,,} ; do
            case "${ccc,,}" in
                * )
                    if [ -v ${client_cache_prefix}_${ccc^^}_EXTENSIONS ] ; then
                        truefalse_onoff ${client_cache_prefix}_${ccc^^}_LOG lowercase;
                        client_cache_types+=$(cat <<EOF

            location ~* \.($(set -o posix ; set | grep "${client_cache_prefix}_${ccc^^}_EXTENSIONS=" | cut -d = -f 2 | sed "s/,/|/g"))$ {
                log_not_found     $(set -o posix ; set | grep "${client_cache_prefix}_${ccc^^}_LOG=" | cut -d = -f 2);
                expires           $(set -o posix ; set | grep "${client_cache_prefix}_${ccc^^}_EXPIRES=" | cut -d = -f 2);
            }

EOF
                                            )
                    fi
                ;;
            esac
        done

        cat << EOF > /etc/nginx/snippets/sites.enabled/${site}/cache-client.conf
${client_cache_types}
EOF
    }

    case "${NGINX_ENABLE_CLIENT_CACHE,,}" in
        all )
            print_info "[configure_site] [${site}] Enabled Client Caching"
            print_debug "[configure_site] [${site}] [client_caching] Using 'all' value"
            call create_cache_config
        ;;
        "${1}" )
            print_info "[configure_site] [${site}] Enabled Client Caching"
            print_debug "[configure_site] [${site}] [client_caching] Using 'site' value"
            call create_cache_config
        ;;
        none | false )
            rm -rf /etc/nginx/snippets/sites.enabled/${site}/cache-client.conf
        ;;
    esac

    if [ -v NGINX_${site^^}_ENABLE_CLIENT_CACHE ] ; then
        local clientcache_value="$(set -o posix ; set | grep "NGINX_${site^^}_ENABLE_CLIENT_CACHE=" | cut -d = -f 2)"
        case "${clientcache_value,,}" in
            true )
                print_info "[configure_site] [${site}] Enabled Client Caching"
                call create_cache_config
            ;;
            none | false )
                rm -rf /etc/nginx/snippets/sites.enabled/${site}/cache-client.conf
            ;;
        esac
        unset clientcache_value
    fi
}

nginx_configure_site_exploit_protection() {
    local exploit_link="ln -sf /etc/nginx/snippets/sites.available/deny-exploit_protection.conf /etc/nginx/snippets/sites.enabled/${1}"
    local exploit_remove="rm -rf /etc/nginx/snippets/sites.enabled/${1}/deny-exploit_protection.conf"

    case "${NGINX_ENABLE_EXPLOIT_PROTECTION,,}" in
        true )
            print_info "[configure_site] [${site}] Enabled Exploit protection"
            print_warn "[configure_site] [${site}] [exploit_protection] Using legacy 'TRUE' value - Convert to 'NGINX_${site^^}_ENABLE_EXPLOIT_PROTECTION'"
            eval "${exploit_link}"
        ;;
        all )
            print_info "[configure_site] [${site}] Enabled Exploit protection"
            print_debug "[configure_site] [${site}] [exploit_protection] Using 'all' value"
            eval "${exploit_link}"
        ;;
        "${1}" )
            print_info "[configure_site] [${site}] Enabled Exploit protection"
            print_debug "[configure_site] [${site}] [exploit_protection] Using 'site' value"
            eval "${exploit_link}"
        ;;
        none | false )
            eval "${exploit_remove}"
        ;;
    esac

    if [ -v NGINX_${site^^}_ENABLE_EXPLOIT_PROTECTION ] ; then
        local exploit_value="$(set -o posix ; set | grep "NGINX_${site^^}_EXPLOIT_PROTECTION=" | cut -d = -f 2)"
        case "${exploit_value,,}" in
            true )
                print_info "[configure_site] [${site}] Enabled Exploit protection"
                eval "${exploit_link}"
            ;;
            none | false )
                eval "${exploit_remove}"
            ;;
        esac
        unset exploit_value
    fi

    unset exploit_link
    unset exploit_remove
}

nginx_configure_site_default() {
    if [ -z "${NGINX_SITE_ENABLED}" ] && [ ! -f "/etc/nginx/sites.available/default.conf" ] && [ ! -f "/container/init/init.d/20-php-fpm" ] ; then
        cat <<EOF | silent tee /etc/nginx/sites.available/default.conf
server {
    ### Don't Touch This
    ### Default ${IMAGE_NAME} configuration - Please see README.md to customize
    listen ${NGINX_LISTEN_PORT};
    server_name localhost;
    root ${NGINX_WEBROOT};
    ###

    include ${NGINX_HEADER_FILE};

    ### Populate your custom directives here
    index  index.html index.htm;

    location / {
    #
    }

    ### Don't edit past here

}
EOF
        NGINX_SITE_ENABLED=default
        if var_true "${NGINX_ENABLE_CREATE_SAMPLE_HTML}" ; then nginx_create_sample_html ; fi
    fi
}

nginx_configure_site_includes() {
    if [ -v NGINX_INCLUDE_CONFIGURATION ] ; then
        case "${NGINX_INCLUDE_CONFIGURATION}" in
            * )
                print_info "[configure_site] [${site}] Enabled site includes"
                print_warn "[configure_site] [${site}] [site_includes] Deprecated variable NGINX_INCLUDE_CONFIGURATION found! Convert to  NGINX_${site^^}_INCLUDE_CONFIGURATION"
                sed -i "\|### Don't edit past here|a\ \ \ \ \    include ${NGINX_INCLUDE_CONFIGURATION};" "${1}"
            ;;
        esac
    fi

    if [ -v NGINX_${site^^}_INCLUDE_CONFIGURATION ] ; then
        print_info "[configure_site] [${site}] Enabled site includes"
        sed -i "\|### Don't edit past here|a\ \ \ \ \    include $(set -o posix ; set | grep "NGINX_${site^^}_EXPLOIT_PROTECTION=" | cut -d = -f 2)" "${1}"
    fi
}

nginx_create_sample_html() {
    if [ ! -f "${NGINX_WEBROOT}/index.html" ]; then
        print_notice "Creating sample index.html"
        mkdir -p "${NGINX_WEBROOT}"
        cat <<EOF > "${NGINX_WEBROOT}"/index.html
<html>
<title>Default Page</title>
<h2>Container is working</h2>
Congratulations! Your ${IMAGE_NAME} image is working. You are seeing this because you don't have an index.html file in your ${NGINX_WEBROOT} directory.
</html>
EOF
        chown -R "${NGINX_USER}":"${NGINX_GROUP}" "${NGINX_WEBROOT}"/index.html
    fi
}

nginx_post_init() {
    create_folder "${NGINX_WEBROOT}" "${NGINX_USER}:${NGINX_GROUP}" 750
    if var_true "${NGINX_FORCE_RESET_PERMISSIONS}" ; then
        chown -R "${NGINX_USER}":"${NGINX_GROUP}" "${NGINX_WEBROOT}"
    fi
}

nginx_site_enable() {
    if [ -n "${1}" ]; then
        if [ -f "/override/nginx/sites.available/${1}.conf" ] ; then
            print_debug "Enabling Override Nginx Site '${1}.conf'"
            ln -sf /override/nginx/sites.available/"${1}".conf /etc/nginx/sites.enabled
        elif [ -f "/etc/nginx/sites.available/${1}.conf" ]; then
            print_debug "Enabling Nginx Site '${1}.conf'"
            ln -sf /etc/nginx/sites.available/"${1}".conf /etc/nginx/sites.enabled
        else
            print_error "Cannot enable site ${1} as it doesn't exist!"
            exit 1
        fi
    else
        print_error "Need configuration file as argument to utilize 'nginx_site_enable' function"
    fi
}

nginx_site_disable() {
    if [ -n "${1}" ]; then
        if [ "${1,,}" = "all" ] ; then
            for site in $(find /etc/nginx/sites.enabled/*.conf -type f ! -name *.enc* -print -maxdepth 1 2>/dev/null); do
                print_debug "Disabling Nginx Site '$(basename "${site}")"
                rm -rf /etc/nginx/sites.enabled/"$(basename "${site}")"
            done
        else
            if [ -f "/etc/nginx/sites.enabled/${1}.conf" ]; then
                print_debug "Disabling Nginx Site '${1}.conf'"
                rm -rf /etc/nginx/sites.enabled/"${1}"*
            else
                print_error "Cannot disable site '${1}' as it doesn't exist in /etc/nginx/sites.enabled!"
                exit 1
            fi
        fi
    else
        print_error "Need configuration file as argument to utilize 'nginx_site_disable' function"
    fi
}

nginx_snippet() {
    case "${1,,}" in
        server)
            if var_true "${2}" ; then
                if [ -f /etc/nginx/snippets/server.available/"${3}" ]; then
                    ln -sf /etc/nginx/snippets/server.available/"${3}" /etc/nginx/snippets/server.enabled/
                else
                    print_warn "[snippets] [server] Can't enable '${3}' because it doesn't exist!"
                fi
            else
                rm -rf /etc/nginx/snippets/server.enabled/"${3}"
            fi
        ;;
        site)
            :
        ;;
    esac
}

